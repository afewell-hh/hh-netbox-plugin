# Parallel Deployment Architecture
## Non-Conflicting Port Strategy for Platform Modernization

*Generated by ruv-swarm MDD-aligned orchestration*  
*Date: 2025-08-16*  
*Critical Requirement: Keep existing NetBox/HNP running during migration*

---

## üéØ Overview

This document defines the parallel deployment architecture that allows the new cloud-native platform to run alongside the existing NetBox/HNP Django container without port conflicts or service interruptions.

---

## üîå Port Allocation Strategy

### Current NetBox/HNP Ports (RESERVED - DO NOT USE)
```yaml
existing_netbox_hnp:
  web_interface: 8000       # Django application
  postgres_db: 5432         # PostgreSQL database
  redis_cache: 6379         # Redis cache
  netbox_worker: internal   # Background workers
```

### New Platform Port Allocations (NON-CONFLICTING)
```yaml
new_platform:
  # Core Services
  web_interface: 8100       # New progressive web app (+100 offset)
  api_gateway: 8101         # API gateway service
  graphql_endpoint: 8102    # GraphQL API
  websocket_server: 8103    # Real-time agent coordination
  
  # Agent Coordination
  ruv_swarm_coordinator: 8200  # ruv-swarm orchestration
  agent_memory_store: 8201     # Agent memory persistence
  quality_gate_validator: 8202 # MDD validation service
  
  # WASM Runtime
  wasmcloud_control: 8300   # WasmCloud control plane
  wasmcloud_actors: 8301     # WASM actor runtime
  capability_providers: 8302 # Capability provider interface
  
  # Kubernetes Services
  k8s_api_proxy: 8400       # Kubernetes API proxy
  gitops_webhook: 8401       # GitOps webhook receiver
  fabric_sync_service: 8402  # Fabric synchronization
  
  # Development & Monitoring
  dev_server: 3100          # Vite development server (+100 offset)
  storybook: 6100           # Component documentation (+100 offset)  
  prometheus_metrics: 9191   # Metrics endpoint (avoid 9090)
  grafana_dashboard: 3200    # Monitoring dashboard (+200 offset)
  
  # Database Services (Separate Instances)
  postgres_new: 5433        # New PostgreSQL (+1 offset)
  redis_new: 6380           # New Redis (+1 offset)
  mongodb_agents: 27017     # Agent memory store
```

---

## üê≥ Docker Compose Configuration

### Parallel Container Strategy
```yaml
version: '3.8'

services:
  # EXISTING SERVICES (DO NOT MODIFY)
  netbox:
    container_name: netbox-docker-netbox-1
    ports:
      - "8000:8000"  # Keep existing
    networks:
      - netbox_network
      
  # NEW PLATFORM SERVICES (NON-CONFLICTING)
  new_platform_web:
    container_name: hedgehog-platform-web
    image: hedgehog-platform:latest
    ports:
      - "8100:8100"  # New web interface
      - "8101:8101"  # API gateway
    environment:
      - LEGACY_NETBOX_URL=http://localhost:8000
      - ENABLE_MIGRATION_MODE=true
    networks:
      - platform_network
      - netbox_network  # Bridge for migration
      
  ruv_swarm_coordinator:
    container_name: ruv-swarm-coordinator
    image: ruv-swarm:latest
    ports:
      - "8200:8200"
    volumes:
      - ./agent_memory:/app/memory
    networks:
      - platform_network
      
  wasmcloud_runtime:
    container_name: wasmcloud-runtime
    image: wasmcloud/wasmcloud:latest
    ports:
      - "8300:8300"
      - "8301:8301"
    networks:
      - platform_network

networks:
  netbox_network:
    name: netbox_default
    external: true  # Use existing NetBox network
    
  platform_network:
    name: platform_modernization
    driver: bridge
```

---

## üîÑ Migration Bridge Configuration

### Data Synchronization Strategy
```python
# Migration bridge configuration
MIGRATION_BRIDGE = {
    "sync_mode": "bidirectional",
    "conflict_resolution": "legacy_wins",  # Existing system has priority
    
    "data_sync": {
        "source": "http://localhost:8000/api",  # Existing NetBox
        "target": "http://localhost:8101/api",  # New platform
        "sync_interval": "5_minutes",
        "validation": "checksum_verification"
    },
    
    "agent_coordination": {
        "migration_agents": [
            "data_sync_validator",
            "schema_migrator",
            "conflict_resolver",
            "rollback_manager"
        ],
        "memory_persistence": "redis://localhost:6380"
    }
}
```

---

## üö¶ Validation Checkpoints

### User Validation Points
These are critical points where user validation is requested before proceeding:

#### Phase 2A Checkpoints (Weeks 1-4)
1. **Week 1 Checkpoint**: Port allocation validation
   - Verify no port conflicts exist
   - Test parallel container startup
   - Validate network connectivity

2. **Week 2 Checkpoint**: Agent coordination validation
   - Demonstrate ruv-swarm orchestration
   - Show memory persistence working
   - Validate quality gates

3. **Week 3 Checkpoint**: Context injection validation
   - Verify token reduction metrics
   - Test effectiveness scoring
   - Validate memory patterns

4. **Week 4 Checkpoint**: Foundation completion
   - Full parallel deployment test
   - Performance benchmarks
   - Ready for Phase 2B approval

### Validation Framework
```yaml
validation_checkpoints:
  notification_method: "github_issue_comment"
  validation_criteria:
    - functional_tests_passing
    - no_port_conflicts_detected
    - existing_system_unaffected
    - performance_targets_met
    
  rollback_trigger:
    - validation_failure
    - user_rejection
    - performance_degradation
```

---

## üõ°Ô∏è Risk Mitigation

### Port Conflict Prevention
```bash
#!/bin/bash
# Port conflict detection script

echo "Checking for port conflicts..."

# Check all allocated ports
PORTS=(8100 8101 8102 8103 8200 8201 8202 8300 8301 8302 8400 8401 8402 3100 6100 9191 3200 5433 6380 27017)

for PORT in "${PORTS[@]}"; do
    if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null ; then
        echo "‚ùå Port $PORT is already in use!"
        exit 1
    else
        echo "‚úÖ Port $PORT is available"
    fi
done

echo "‚úÖ All ports available for parallel deployment"
```

### Nginx Reverse Proxy Configuration
```nginx
# Unified access through reverse proxy
server {
    listen 80;
    server_name hedgehog.local;
    
    # Existing NetBox (unchanged)
    location /netbox/ {
        proxy_pass http://localhost:8000/;
    }
    
    # New Platform (parallel)
    location /platform/ {
        proxy_pass http://localhost:8100/;
    }
    
    # API Gateway
    location /api/v2/ {
        proxy_pass http://localhost:8101/;
    }
    
    # WebSocket for agent coordination
    location /ws/ {
        proxy_pass http://localhost:8103/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## üìä Monitoring & Observability

### Parallel System Monitoring
```yaml
monitoring_strategy:
  existing_system:
    endpoint: "http://localhost:8000/metrics"
    dashboard: "Existing NetBox Dashboard"
    alerts: "Keep all existing alerts active"
    
  new_platform:
    endpoint: "http://localhost:9191/metrics"
    dashboard: "http://localhost:3200"
    alerts: "New platform-specific alerts"
    
  comparison_metrics:
    - request_latency_comparison
    - memory_usage_comparison
    - error_rate_comparison
    - throughput_comparison
```

---

## üîÑ Rollback Strategy

### Instant Rollback Capability
```bash
#!/bin/bash
# Emergency rollback script

echo "üö® Initiating platform rollback..."

# Stop new platform containers
docker-compose -f docker-compose.new-platform.yml down

# Verify existing NetBox still running
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health | grep -q "200"; then
    echo "‚úÖ Existing NetBox/HNP is healthy"
else
    echo "‚ùå WARNING: Existing NetBox/HNP needs attention"
fi

# Clear new platform data (optional)
read -p "Clear new platform data? (y/n): " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
    rm -rf ./new_platform_data/*
    echo "‚úÖ New platform data cleared"
fi

echo "‚úÖ Rollback complete - existing system unaffected"
```

---

## üéØ Success Criteria

### Parallel Deployment Validation
- ‚úÖ Both systems running simultaneously without conflicts
- ‚úÖ No performance degradation in existing system
- ‚úÖ Data synchronization working correctly
- ‚úÖ User can access both systems independently
- ‚úÖ Rollback tested and verified

### Performance Targets (Parallel Mode)
- Existing system: No degradation from baseline
- New platform: Meeting all Phase 2 targets
- Resource usage: <2x combined vs existing alone
- Network latency: <10ms inter-system communication

---

## üìã Implementation Checklist

### Pre-Deployment
- [ ] Verify all new platform ports are available
- [ ] Create docker-compose.new-platform.yml
- [ ] Setup monitoring for both systems
- [ ] Configure nginx reverse proxy
- [ ] Test rollback procedure

### Deployment
- [ ] Start new platform containers
- [ ] Verify no port conflicts
- [ ] Test inter-system connectivity
- [ ] Validate data bridge working
- [ ] Confirm existing system unaffected

### Post-Deployment
- [ ] Monitor both systems for 24 hours
- [ ] Collect performance metrics
- [ ] Document any issues
- [ ] Update GitHub issues with status
- [ ] Request user validation

---

*This parallel deployment architecture ensures zero disruption to the existing NetBox/HNP system while enabling progressive migration to the new cloud-native platform with comprehensive validation checkpoints and instant rollback capability.*