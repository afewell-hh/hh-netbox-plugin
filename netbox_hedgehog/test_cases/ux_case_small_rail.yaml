meta:
  case_id: ux_case_small_rail
  name: UX Case Small Rail
  description: Small backend rail-optimized topology for regression coverage
  version: 1
  managed_by: yaml
  tags: [regression, rail]

reference_data:
  manufacturers:
    - id: test_mfg
      name: Test Mfg
      slug: test-mfg
    - id: nvidia
      name: NVIDIA
      slug: nvidia
  device_types:
    - id: test_server_be
      manufacturer: test_mfg
      model: Test Server FE+BE
      slug: test-server-fe-be
      interface_templates:
        - name: eth1
          type: 200gbase-x-qsfp56
        - name: cx7-1
          type: 400gbase-x-qsfpdd
        - name: cx7-2
          type: 400gbase-x-qsfpdd
    - id: test_switch
      manufacturer: test_mfg
      model: Test Switch 64x800G
      slug: test-switch-64x800g
      interface_templates:
        - name: E1/1
          type: 800gbase-x-qsfpdd
        - name: E1/2
          type: 800gbase-x-qsfpdd
        - name: E1/3
          type: 800gbase-x-qsfpdd
        - name: E1/4
          type: 800gbase-x-qsfpdd
  device_type_extensions:
    - id: test_switch_ext
      device_type: test_switch
      mclag_capable: false
      hedgehog_roles: [spine, server-leaf]
      supported_breakouts: [1x800g, 2x400g, 4x200g]
      native_speed: 800
      uplink_ports: 8
  breakout_options:
    - id: b_1x800
      breakout_id: rail-1x800g
      from_speed: 800
      logical_ports: 1
      logical_speed: 800
      optic_type: QSFP-DD
    - id: b_2x400
      breakout_id: rail-2x400g
      from_speed: 800
      logical_ports: 2
      logical_speed: 400
      optic_type: QSFP-DD
    - id: b_4x200
      breakout_id: rail-4x200g
      from_speed: 800
      logical_ports: 4
      logical_speed: 200
      optic_type: QSFP-DD
  module_types:
    - id: nic_bf3
      manufacturer: nvidia
      model: BlueField-3 BF3220
      interface_templates:
        - name: p0
          type: other
        - name: p1
          type: other
    - id: nic_cx7_single
      manufacturer: nvidia
      model: ConnectX-7 (Single-Port)
      interface_templates:
        - name: port0
          type: other

plan:
  name: UX Case Small Rail
  status: draft
  description: Small rail-optimized backend case

switch_classes:
  - switch_class_id: fe-leaf
    fabric: frontend
    hedgehog_role: server-leaf
    device_type_extension: test_switch_ext
    uplink_ports_per_switch: 8
    mclag_pair: false
  - switch_class_id: be-rail-leaf
    fabric: backend
    hedgehog_role: server-leaf
    device_type_extension: test_switch_ext
    uplink_ports_per_switch: 8
    mclag_pair: false

switch_port_zones:
  - switch_class: fe-leaf
    zone_name: server-downlinks
    zone_type: server
    port_spec: 1-16
    breakout_option: b_4x200
    allocation_strategy: sequential
    priority: 100
  - switch_class: be-rail-leaf
    zone_name: server-downlinks
    zone_type: server
    port_spec: 1-16
    breakout_option: b_2x400
    allocation_strategy: sequential
    priority: 100

server_classes:
  - server_class_id: gpu-with-backend-small
    description: Small backend-enabled GPU pool
    category: gpu
    quantity: 2
    gpus_per_server: 8
    server_device_type: test_server_be

server_connections:
  - server_class: gpu-with-backend-small
    connection_id: fe
    connection_name: frontend
    nic_module_type: nic_bf3
    port_index: 0
    ports_per_connection: 1
    hedgehog_conn_type: unbundled
    distribution: alternating
    target_zone: fe-leaf/server-downlinks
    speed: 200
    port_type: data
  - server_class: gpu-with-backend-small
    connection_id: be-rail-0
    connection_name: backend-rail-0
    nic_module_type: nic_cx7_single
    port_index: 0
    ports_per_connection: 1
    hedgehog_conn_type: unbundled
    distribution: rail-optimized
    target_zone: be-rail-leaf/server-downlinks
    speed: 400
    rail: 0
    port_type: data
  - server_class: gpu-with-backend-small
    connection_id: be-rail-1
    connection_name: backend-rail-1
    nic_module_type: nic_cx7_single
    port_index: 0
    ports_per_connection: 1
    hedgehog_conn_type: unbundled
    distribution: rail-optimized
    target_zone: be-rail-leaf/server-downlinks
    speed: 400
    rail: 1
    port_type: data

expected:
  counts:
    server_classes: 1
    switch_classes: 2
    connections: 3
