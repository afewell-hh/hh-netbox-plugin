{% comment %}
Real-time Status Indicators Component
Live status indicators for fabric monitoring with WebSocket updates
{% endcomment %}

<div class="realtime-status-container" data-fabric-id="{{ fabric.pk }}">
    <!-- Fabric Connection Status -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="mdi mdi-access-point-network"></i> 
                Real-time Status
            </h5>
            <div class="realtime-connection-indicator">
                <span id="websocket-status" class="badge badge-secondary">
                    <i class="mdi mdi-loading mdi-spin"></i> Connecting...
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Fabric Status -->
                <div class="col-md-3">
                    <div class="status-indicator-card">
                        <div class="status-header">
                            <i class="mdi mdi-server-network"></i>
                            <span class="status-label">Fabric Status</span>
                        </div>
                        <div id="fabric-status" class="status-value">
                            <span class="badge badge-{{ fabric.status|default:'secondary' }}">
                                {{ fabric.get_status_display|default:'Unknown' }}
                            </span>
                        </div>
                        <div class="status-timestamp" id="fabric-status-timestamp">
                            Last updated: {{ fabric.last_sync|default:'Never'|date:'M d, H:i' }}
                        </div>
                    </div>
                </div>
                
                <!-- Connection Status -->
                <div class="col-md-3">
                    <div class="status-indicator-card">
                        <div class="status-header">
                            <i class="mdi mdi-lan-connect"></i>
                            <span class="status-label">K8s Connection</span>
                        </div>
                        <div id="connection-status" class="status-value">
                            <span class="badge badge-{{ fabric.connection_status|default:'secondary' }}">
                                {{ fabric.get_connection_status_display|default:'Unknown' }}
                            </span>
                        </div>
                        <div class="status-timestamp" id="connection-status-timestamp">
                            {% if fabric.kubernetes_server %}
                                Endpoint: {{ fabric.kubernetes_server|truncatechars:30 }}
                            {% else %}
                                Not configured
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Watch Status -->
                <div class="col-md-3">
                    <div class="status-indicator-card">
                        <div class="status-header">
                            <i class="mdi mdi-eye"></i>
                            <span class="status-label">Watch Status</span>
                        </div>
                        <div id="watch-status" class="status-value">
                            <span class="badge badge-{{ fabric.watch_status|default:'secondary' }}">
                                {{ fabric.get_watch_status_display|default:'Inactive' }}
                            </span>
                        </div>
                        <div class="status-timestamp" id="watch-status-timestamp">
                            Events: <span id="watch-event-count">{{ fabric.watch_event_count|default:0 }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sync Status -->
                <div class="col-md-3">
                    <div class="status-indicator-card">
                        <div class="status-header">
                            <i class="mdi mdi-sync"></i>
                            <span class="status-label">Git Sync</span>
                        </div>
                        <div id="sync-status" class="status-value">
                            <span class="badge badge-{{ fabric.sync_status|default:'secondary' }}">
                                {{ fabric.get_sync_status_display|default:'Never synced' }}
                            </span>
                        </div>
                        <div class="status-timestamp" id="sync-status-timestamp">
                            Last sync: <span id="last-sync-time">{{ fabric.last_git_sync|default:'Never'|date:'M d, H:i' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CRD Status Overview -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="mdi mdi-format-list-numbered"></i> 
                CRD Status Overview
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="crd-counter">
                        <div class="counter-value" id="total-crds">{{ fabric.crd_count|default:0 }}</div>
                        <div class="counter-label">Total CRDs</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="crd-counter">
                        <div class="counter-value text-success" id="active-crds">{{ fabric.active_crd_count|default:0 }}</div>
                        <div class="counter-label">Active</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="crd-counter">
                        <div class="counter-value text-danger" id="error-crds">{{ fabric.error_crd_count|default:0 }}</div>
                        <div class="counter-label">Errors</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="crd-counter">
                        <div class="counter-value text-primary" id="vpc-count">{{ fabric.vpcs_count|default:0 }}</div>
                        <div class="counter-label">VPCs</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="crd-counter">
                        <div class="counter-value text-info" id="connection-count">{{ fabric.connections_count|default:0 }}</div>
                        <div class="counter-label">Connections</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="crd-counter">
                        <div class="counter-value text-warning" id="switch-count">{{ fabric.switches_count|default:0 }}</div>
                        <div class="counter-label">Switches</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Event Feed -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="mdi mdi-pulse"></i> 
                Live Event Feed
            </h6>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" id="clear-events">
                    <i class="mdi mdi-delete"></i> Clear
                </button>
                <button type="button" class="btn btn-outline-secondary" id="pause-events" data-paused="false">
                    <i class="mdi mdi-pause"></i> Pause
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="event-feed" class="event-feed" style="max-height: 300px; overflow-y: auto;">
                <div class="event-feed-empty text-center text-muted p-4">
                    <i class="mdi mdi-information-outline"></i>
                    Waiting for real-time events...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Progress Modal for Sync Operations -->
<div class="modal fade" id="sync-progress-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="mdi mdi-sync mdi-spin"></i>
                    Git Sync Progress
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div id="sync-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: 0%"></div>
                </div>
                <div id="sync-progress-message" class="text-center">
                    Initializing sync...
                </div>
                <div id="sync-progress-details" class="mt-3">
                    <!-- Detailed progress info will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.realtime-status-container {
    position: relative;
}

.realtime-connection-indicator {
    position: relative;
}

#websocket-status.badge-success::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #28a745;
    border-radius: 50%;
    margin-right: 5px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.status-indicator-card {
    text-align: center;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

.status-indicator-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.status-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #6c757d;
}

.status-header i {
    margin-right: 0.5rem;
    font-size: 1.1em;
}

.status-value {
    margin-bottom: 0.25rem;
}

.status-timestamp {
    font-size: 0.85em;
    color: #6c757d;
}

.crd-counter {
    text-align: center;
    padding: 0.75rem;
}

.counter-value {
    font-size: 1.75rem;
    font-weight: bold;
    line-height: 1;
}

.counter-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.event-feed {
    background-color: #f8f9fa;
}

.event-feed-empty {
    border: 2px dashed #dee2e6;
    border-radius: 0.25rem;
    margin: 1rem;
}

.event-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    transition: background-color 0.3s ease;
}

.event-item:hover {
    background-color: #e9ecef;
}

.event-item:last-child {
    border-bottom: none;
}

.event-item.event-new {
    background-color: #d1ecf1;
    border-left: 4px solid #17a2b8;
}

.event-timestamp {
    font-size: 0.8rem;
    color: #6c757d;
}

.event-type {
    font-weight: 500;
    margin-right: 0.5rem;
}

.event-message {
    margin-top: 0.25rem;
    font-size: 0.9rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .status-indicator-card {
        margin-bottom: 1rem;
    }
    
    .crd-counter {
        margin-bottom: 0.5rem;
    }
}

/* Status badge colors */
.badge-active { background-color: #28a745; }
.badge-inactive { background-color: #6c757d; }
.badge-starting { background-color: #ffc107; }
.badge-error { background-color: #dc3545; }
.badge-stopped { background-color: #6c757d; }
.badge-connected { background-color: #28a745; }
.badge-disconnected { background-color: #dc3545; }
.badge-unknown { background-color: #6c757d; }
.badge-live { background-color: #28a745; }
.badge-synced { background-color: #28a745; }
.badge-never_synced { background-color: #6c757d; }
.badge-sync_failed { background-color: #dc3545; }
.badge-syncing { background-color: #17a2b8; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize real-time status indicators
    const fabricId = document.querySelector('.realtime-status-container').dataset.fabricId;
    
    if (fabricId && window.HedgehogWebSocket) {
        const wsManager = new window.HedgehogWebSocket.Manager({ debug: true });
        const fabricClient = wsManager.connectToFabric(parseInt(fabricId));
        
        // WebSocket connection status
        const wsStatusElement = document.getElementById('websocket-status');
        
        fabricClient.on('connected', function() {
            wsStatusElement.innerHTML = '<i class="mdi mdi-check-circle"></i> Connected';
            wsStatusElement.className = 'badge badge-success';
        });
        
        fabricClient.on('disconnected', function() {
            wsStatusElement.innerHTML = '<i class="mdi mdi-close-circle"></i> Disconnected';
            wsStatusElement.className = 'badge badge-danger';
        });
        
        fabricClient.on('reconnecting', function(data) {
            wsStatusElement.innerHTML = `<i class="mdi mdi-loading mdi-spin"></i> Reconnecting (${data.attempt}/${data.maxAttempts})`;
            wsStatusElement.className = 'badge badge-warning';
        });
        
        // Fabric status updates
        fabricClient.on('fabric_status_update', function(data) {
            updateFabricStatus(data.data);
        });
        
        // CRD events
        fabricClient.on('crd_event', function(data) {
            updateCRDCounts(data.data);
            addEventToFeed('CRD Event', data.data);
        });
        
        // Sync progress
        fabricClient.on('sync_progress', function(data) {
            updateSyncProgress(data.data);
            addEventToFeed('Sync Progress', data.data);
        });
        
        // Watch status changes
        fabricClient.on('watch_status_change', function(data) {
            updateWatchStatus(data.data);
            addEventToFeed('Watch Status', data.data);
        });
        
        // Event feed controls
        const clearEventsBtn = document.getElementById('clear-events');
        const pauseEventsBtn = document.getElementById('pause-events');
        let eventsPaused = false;
        
        clearEventsBtn.addEventListener('click', function() {
            const eventFeed = document.getElementById('event-feed');
            eventFeed.innerHTML = '<div class="event-feed-empty text-center text-muted p-4"><i class="mdi mdi-information-outline"></i> Event feed cleared</div>';
        });
        
        pauseEventsBtn.addEventListener('click', function() {
            eventsPaused = !eventsPaused;
            this.dataset.paused = eventsPaused;
            this.innerHTML = eventsPaused ? 
                '<i class="mdi mdi-play"></i> Resume' : 
                '<i class="mdi mdi-pause"></i> Pause';
        });
        
        // Update functions
        function updateFabricStatus(data) {
            if (data.status) {
                const statusElement = document.getElementById('fabric-status');
                statusElement.innerHTML = `<span class="badge badge-${data.status}">${data.status_display || data.status}</span>`;
            }
            
            if (data.last_sync) {
                const timestampElement = document.getElementById('fabric-status-timestamp');
                timestampElement.textContent = `Last updated: ${new Date(data.last_sync).toLocaleString()}`;
            }
        }
        
        function updateCRDCounts(data) {
            if (data.total_crds !== undefined) {
                document.getElementById('total-crds').textContent = data.total_crds;
            }
            if (data.active_crds !== undefined) {
                document.getElementById('active-crds').textContent = data.active_crds;
            }
            if (data.error_crds !== undefined) {
                document.getElementById('error-crds').textContent = data.error_crds;
            }
            
            // Update specific CRD type counts if available
            ['vpc_count', 'connection_count', 'switch_count'].forEach(field => {
                if (data[field] !== undefined) {
                    const element = document.getElementById(field.replace('_', '-'));
                    if (element) {
                        element.textContent = data[field];
                    }
                }
            });
        }
        
        function updateSyncProgress(data) {
            if (data.event_type === 'sync_started') {
                showSyncProgressModal();
            } else if (data.event_type === 'sync_completed' || data.event_type === 'sync_failed') {
                hideSyncProgressModal();
                
                // Update sync status
                const syncStatus = document.getElementById('sync-status');
                const badge = data.event_type === 'sync_completed' ? 'badge-success' : 'badge-danger';
                syncStatus.innerHTML = `<span class="badge ${badge}">${data.message || data.event_type}</span>`;
                
                // Update last sync time
                const lastSyncElement = document.getElementById('last-sync-time');
                lastSyncElement.textContent = new Date().toLocaleString();
            } else if (data.progress !== undefined) {
                updateSyncProgressBar(data.progress, data.message);
            }
        }
        
        function updateWatchStatus(data) {
            if (data.status) {
                const watchStatus = document.getElementById('watch-status');
                watchStatus.innerHTML = `<span class="badge badge-${data.status}">${data.status_display || data.status}</span>`;
            }
            
            if (data.event_count !== undefined) {
                document.getElementById('watch-event-count').textContent = data.event_count;
            }
        }
        
        function addEventToFeed(eventType, data) {
            if (eventsPaused) return;
            
            const eventFeed = document.getElementById('event-feed');
            
            // Remove empty message if present
            const emptyMessage = eventFeed.querySelector('.event-feed-empty');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            // Create event item
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item event-new';
            eventItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="event-type">${eventType}</span>
                        <span class="event-timestamp">${new Date().toLocaleTimeString()}</span>
                        <div class="event-message">${data.message || JSON.stringify(data, null, 2)}</div>
                    </div>
                </div>
            `;
            
            // Add to top of feed
            eventFeed.insertBefore(eventItem, eventFeed.firstChild);
            
            // Remove highlight after animation
            setTimeout(() => {
                eventItem.classList.remove('event-new');
            }, 2000);
            
            // Limit number of events
            const eventItems = eventFeed.querySelectorAll('.event-item');
            if (eventItems.length > 50) {
                eventItems[eventItems.length - 1].remove();
            }
        }
        
        function showSyncProgressModal() {
            $('#sync-progress-modal').modal('show');
            document.getElementById('sync-progress-bar').style.width = '0%';
            document.getElementById('sync-progress-message').textContent = 'Starting sync...';
        }
        
        function hideSyncProgressModal() {
            setTimeout(() => {
                $('#sync-progress-modal').modal('hide');
            }, 2000);
        }
        
        function updateSyncProgressBar(progress, message) {
            const progressBar = document.getElementById('sync-progress-bar');
            const progressMessage = document.getElementById('sync-progress-message');
            
            progressBar.style.width = `${progress}%`;
            progressMessage.textContent = message || `${progress}% complete`;
            
            if (progress >= 100) {
                progressBar.classList.add('bg-success');
                progressBar.classList.remove('progress-bar-animated');
            }
        }
        
        // Request initial status
        fabricClient.on('connected', function() {
            fabricClient.requestStatus();
        });
    }
});
</script>