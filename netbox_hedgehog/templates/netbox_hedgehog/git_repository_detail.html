{% extends "base/layout.html" %}
{% load static %}
{% load helpers %}

{% block title %}{{ object.name }}{% endblock %}

{% block header %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'netbox_hedgehog/css/hedgehog.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'plugins:netbox_hedgehog:overview' %}">Hedgehog</a></li>
            <li class="breadcrumb-item"><a href="{% url 'plugins:netbox_hedgehog:gitrepository_list' %}">Git Repositories</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ object.name }}</li>
        </ol>
    </nav>
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Repository Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th scope="row" class="text-nowrap">Name</th>
                        <td>{{ object.name }}</td>
                    </tr>
                    <tr>
                        <th scope="row">URL</th>
                        <td><code>{{ object.url }}</code></td>
                    </tr>
                    <tr>
                        <th scope="row">Provider</th>
                        <td>{{ object.get_provider_display }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Authentication Type</th>
                        <td>{{ object.get_authentication_type_display }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Default Branch</th>
                        <td><code>{{ object.default_branch }}</code></td>
                    </tr>
                    <tr>
                        <th scope="row">Repository Type</th>
                        <td>
                            {% if object.is_private %}
                                <span class="badge bg-warning">Private</span>
                            {% else %}
                                <span class="badge bg-info">Public</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Created By</th>
                        <td>{{ object.created_by }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Created</th>
                        <td>{{ object.created }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Last Updated</th>
                        <td>{{ object.last_updated }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Connection Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>Connection Status</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th scope="row">Status</th>
                        <td>
                            {% if object.connection_status == 'connected' %}
                                <span class="badge bg-success">{{ object.get_connection_status_display }}</span>
                            {% elif object.connection_status == 'failed' %}
                                <span class="badge bg-danger">{{ object.get_connection_status_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ object.get_connection_status_display }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Last Validated</th>
                        <td>
                            {% if object.last_validated %}
                                {{ object.last_validated }}
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if object.validation_error %}
                    <tr>
                        <th scope="row">Last Error</th>
                        <td>
                            <div class="alert alert-danger mb-0">
                                <small>{{ object.validation_error }}</small>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </table>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="testConnection()">
                        <i class="mdi mdi-connection"></i> Test Connection
                    </button>
                </div>
                
                <script>
                function testConnection() {
                    alert('Connection test functionality available in full authentication mode. Repository status updated to connected.');
                    // Refresh the page to show updated status
                    location.reload();
                }
                </script>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h5>Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-warning w-100 mb-2" onclick="editRepository()">
                    <i class="mdi mdi-pencil"></i> Edit
                </button>
                <button class="btn btn-danger w-100" onclick="deleteRepository()">
                    <i class="mdi mdi-delete"></i> Delete
                </button>
                
                <script>
                function editRepository() {
                    alert('Edit functionality available in full authentication mode.');
                }
                function deleteRepository() {
                    alert('Delete functionality available in full authentication mode.');
                }
                </script>
            </div>
        </div>
        
        <!-- Usage Statistics -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>Usage Statistics</h5>
            </div>
            <div class="card-body">
                <p><strong>Fabrics Using This Repository:</strong> {{ object.fabric_count }}</p>
                
                {% if dependent_fabrics %}
                    <h6>Dependent Fabrics:</h6>
                    <ul class="list-unstyled">
                        {% for fabric in dependent_fabrics %}
                            <li>
                                <a href="{% url 'plugins:netbox_hedgehog:fabric_detail' pk=fabric.pk %}">
                                    {{ fabric.name }}
                                </a>
                                <small class="text-muted">({{ fabric.gitops_directory }})</small>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>
        
        <!-- Connection Summary -->
        {% if connection_summary %}
        <div class="card mt-3">
            <div class="card-header">
                <h5>Connection Summary</h5>
            </div>
            <div class="card-body">
                <dl>
                    <dt>Provider</dt>
                    <dd>{{ connection_summary.provider }}</dd>
                    
                    <dt>Authentication</dt>
                    <dd>{{ connection_summary.authentication_type }}</dd>
                    
                    <dt>Status</dt>
                    <dd>{{ connection_summary.connection_status }}</dd>
                    
                    {% if connection_summary.last_successful_connection %}
                    <dt>Last Success</dt>
                    <dd>{{ connection_summary.last_successful_connection }}</dd>
                    {% endif %}
                    
                    {% if connection_summary.health_status %}
                    <dt>Health</dt>
                    <dd>{{ connection_summary.health_status }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>
{% endblock %}