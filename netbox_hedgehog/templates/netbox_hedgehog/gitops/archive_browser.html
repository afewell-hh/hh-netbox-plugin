{% extends "netbox_hedgehog/base.html" %}
{% load static %}

{% block title %}Archive Browser{% endblock %}

{% block breadcrumbs %}
    <li class="breadcrumb-item"><a href="{% url 'plugins:netbox_hedgehog:fabric_list' %}">Fabrics</a></li>
    <li class="breadcrumb-item"><a href="{% url 'plugins:netbox_hedgehog:gitops_dashboard' %}">GitOps Dashboard</a></li>
    <li class="breadcrumb-item active">Archive Browser</li>
{% endblock %}

{% block hedgehog_content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="mdi mdi-archive text-info"></i> Archive Browser</h2>
                    <p class="text-muted mb-0">Browse and manage archived files from GitOps processing activities</p>
                </div>
                <div>
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-outline-secondary" id="refresh-archives">
                            <i class="mdi mdi-refresh"></i> Refresh
                        </button>
                        <button class="btn btn-outline-warning" id="cleanup-archives">
                            <i class="mdi mdi-broom"></i> Cleanup
                        </button>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="mdi mdi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportArchives('selected')">
                                <i class="mdi mdi-check-box-multiple"></i> Selected Archives
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportArchives('all')">
                                <i class="mdi mdi-select-all"></i> All Archives
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportArchives('metadata')">
                                <i class="mdi mdi-file-table"></i> Metadata Only
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="search-input" class="form-label">Search Archives</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="mdi mdi-magnify"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       id="search-input" 
                                       placeholder="Search by filename, fabric, or content...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="fabric-filter" class="form-label">Fabric</label>
                            <select class="form-select" id="fabric-filter">
                                <option value="">All Fabrics</option>
                                <!-- Populated via JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="date-range" class="form-label">Date Range</label>
                            <select class="form-select" id="date-range">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">Past Week</option>
                                <option value="month">Past Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="archive-type" class="form-label">Archive Type</label>
                            <select class="form-select" id="archive-type">
                                <option value="">All Types</option>
                                <option value="migration">Migration</option>
                                <option value="backup">Backup</option>
                                <option value="cleanup">Cleanup</option>
                                <option value="error">Error Recovery</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" id="apply-filters">
                                    <i class="mdi mdi-filter"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Date Range -->
                    <div class="row mt-3 d-none" id="custom-date-range">
                        <div class="col-md-3">
                            <label for="start-date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start-date">
                        </div>
                        <div class="col-md-3">
                            <label for="end-date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end-date">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Archive Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="mdi mdi-archive display-4 mb-2"></i>
                    <h2 id="total-archives">0</h2>
                    <small>Total Archives</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="mdi mdi-folder-move display-4 mb-2"></i>
                    <h2 id="migration-archives">0</h2>
                    <small>Migration Archives</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="mdi mdi-backup-restore display-4 mb-2"></i>
                    <h2 id="backup-archives">0</h2>
                    <small>Backup Archives</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="mdi mdi-harddisk display-4 mb-2"></i>
                    <h2 id="total-size">0 MB</h2>
                    <small>Total Size</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Archive List -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-folder-multiple"></i> Archived Files
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="timeline-view">
                            <label class="form-check-label" for="timeline-view">Timeline View</label>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary" onclick="changeView('list')" id="list-view-btn">
                                <i class="mdi mdi-view-list"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="changeView('grid')" id="grid-view-btn">
                                <i class="mdi mdi-view-grid"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- List View -->
                    <div id="list-view">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="archives-table">
                                <thead class="table-light">
                                    <tr>
                                        <th width="30">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="select-all-archives">
                                            </div>
                                        </th>
                                        <th>Original File</th>
                                        <th>Archive Type</th>
                                        <th>Fabric</th>
                                        <th>Size</th>
                                        <th>Archived Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="archives-tbody">
                                    <!-- Archives populated via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Grid View -->
                    <div id="grid-view" class="d-none p-3">
                        <div class="row" id="archives-grid">
                            <!-- Archive cards populated via JavaScript -->
                        </div>
                    </div>

                    <!-- Timeline View -->
                    <div id="timeline-view-content" class="d-none p-3">
                        <div class="timeline" id="archives-timeline">
                            <!-- Timeline items populated via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div class="empty-state d-none" id="archives-empty">
                        <i class="mdi mdi-archive"></i>
                        <h5>No Archives Found</h5>
                        <p>No archived files match your current search criteria.</p>
                        <button class="btn btn-outline-primary" onclick="clearFilters()">
                            <i class="mdi mdi-filter-off"></i> Clear Filters
                        </button>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div class="bulk-actions d-none" id="bulk-actions">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-success" onclick="bulkRestore()">
                                <i class="mdi mdi-restore"></i> Restore Selected
                            </button>
                            <button class="btn btn-info" onclick="bulkDownload()">
                                <i class="mdi mdi-download"></i> Download
                            </button>
                            <button class="btn btn-danger" onclick="bulkDelete()">
                                <i class="mdi mdi-delete"></i> Delete
                            </button>
                        </div>
                        <span class="ms-2 text-muted">
                            <span id="selected-count">0</span> selected
                        </span>
                    </div>
                    <nav id="pagination-nav">
                        <!-- Pagination populated via JavaScript -->
                    </nav>
                </div>
            </div>
        </div>

        <!-- Archive Details Panel -->
        <div class="col-lg-4">
            <!-- Selected Archive Details -->
            <div class="card mb-4" id="archive-details-card" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-file-document"></i> Archive Details
                    </h5>
                </div>
                <div class="card-body" id="archive-details-body">
                    <!-- Details populated via JavaScript -->
                </div>
                <div class="card-footer">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="previewArchive()">
                            <i class="mdi mdi-eye"></i> Preview
                        </button>
                        <button class="btn btn-success" onclick="restoreArchive()">
                            <i class="mdi mdi-restore"></i> Restore
                        </button>
                        <button class="btn btn-info" onclick="downloadArchive()">
                            <i class="mdi mdi-download"></i> Download
                        </button>
                    </div>
                </div>
            </div>

            <!-- Archive Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-chart-line"></i> Archive Trends
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="archive-trends-chart" width="300" height="150"></canvas>
                </div>
            </div>

            <!-- Storage Management -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-harddisk"></i> Storage Management
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Storage Usage -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Archive Storage</span>
                            <span class="fw-bold" id="storage-used">0 MB</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar" id="storage-progress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">
                            <span id="storage-percentage">0%</span> of allocated storage used
                        </small>
                    </div>

                    <!-- Storage Actions -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning btn-sm" onclick="optimizeStorage()">
                            <i class="mdi mdi-speedometer"></i> Optimize Storage
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="cleanupOldArchives()">
                            <i class="mdi mdi-delete-clock"></i> Cleanup Old Archives
                        </button>
                    </div>

                    <!-- Cleanup Policy -->
                    <div class="mt-3">
                        <h6>Retention Policy</h6>
                        <div class="retention-policy">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Migration Archives:</small>
                                <small class="fw-bold">30 days</small>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <small>Backup Archives:</small>
                                <small class="fw-bold">90 days</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small>Error Archives:</small>
                                <small class="fw-bold">7 days</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Archive Preview Modal -->
<div class="modal fade" id="archivePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="mdi mdi-file-eye"></i> Archive Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="archive-content">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>File Content</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-secondary" onclick="formatContent('yaml')">YAML</button>
                                    <button class="btn btn-outline-secondary" onclick="formatContent('json')">JSON</button>
                                    <button class="btn btn-outline-secondary" onclick="formatContent('raw')">Raw</button>
                                </div>
                            </div>
                            <pre class="bg-light p-3 rounded" id="archive-content" style="height: 400px; overflow-y: auto;"></pre>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="archive-metadata">
                            <h6>Archive Metadata</h6>
                            <div id="archive-metadata-content">
                                <!-- Metadata populated via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="downloadArchiveFromModal()">
                    <i class="mdi mdi-download"></i> Download
                </button>
                <button type="button" class="btn btn-success" onclick="restoreArchiveFromModal()">
                    <i class="mdi mdi-restore"></i> Restore
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div class="modal fade" id="restoreConfirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-warning">
                    <i class="mdi mdi-restore"></i> Confirm Restore
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="mdi mdi-alert-triangle"></i>
                    <strong>Warning:</strong> This action will restore the archived file to the raw directory and may overwrite existing files.
                </div>
                <div id="restore-details">
                    <!-- Restore details populated via JavaScript -->
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="overwrite-existing">
                    <label class="form-check-label" for="overwrite-existing">
                        Overwrite existing files with the same name
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-restore-btn">
                    <i class="mdi mdi-restore"></i> Restore Archive
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block hedgehog_javascript %}
<script src="{% static 'netbox_hedgehog/js/archive-browser.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Archive Browser Styles */
.archive-card {
    transition: all 0.3s ease;
    cursor: pointer;
    height: 100%;
}

.archive-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.archive-card.selected {
    border-color: var(--bs-primary) !important;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}

.archive-card .card-body {
    padding: 1rem;
}

.archive-type-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.7rem;
}

.timeline {
    position: relative;
    padding-left: 2rem;
    max-height: 500px;
    overflow-y: auto;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: var(--bs-border-color);
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -2.75rem;
    top: 1rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--bs-primary);
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--bs-primary);
}

.timeline-item.migration::before {
    background-color: var(--bs-success);
    box-shadow: 0 0 0 2px var(--bs-success);
}

.timeline-item.backup::before {
    background-color: var(--bs-warning);
    box-shadow: 0 0 0 2px var(--bs-warning);
}

.timeline-item.error::before {
    background-color: var(--bs-danger);
    box-shadow: 0 0 0 2px var(--bs-danger);
}

.timeline-date {
    font-size: 0.875rem;
    color: var(--bs-secondary);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.timeline-content h6 {
    margin-bottom: 0.5rem;
    color: var(--bs-dark);
}

.timeline-content p {
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--bs-secondary);
}

.timeline-actions {
    margin-top: 0.75rem;
}

/* Archive content preview */
.archive-content pre {
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.archive-metadata-content {
    background-color: var(--bs-light);
    border-radius: 0.375rem;
    padding: 1rem;
}

.metadata-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
    border-bottom: 1px solid var(--bs-border-color);
}

.metadata-item:last-child {
    border-bottom: none;
}

.metadata-label {
    font-weight: 600;
    color: var(--bs-secondary);
    min-width: 100px;
}

.metadata-value {
    text-align: right;
    font-family: monospace;
    font-size: 0.875rem;
}

/* Storage visualization */
.retention-policy {
    font-size: 0.875rem;
    background-color: var(--bs-light);
    border-radius: 0.375rem;
    padding: 0.75rem;
}

/* Search and filter highlights */
.search-highlight {
    background-color: yellow;
    padding: 0.1rem 0.2rem;
    border-radius: 0.2rem;
}

/* Bulk selection */
.bulk-actions {
    animation: slideIn 0.3s ease;
}

/* Loading states */
.loading-archives {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--bs-secondary);
}

.loading-archives .spinner-border {
    width: 3rem;
    height: 3rem;
    margin-bottom: 1rem;
}

/* Archive status indicators */
.archive-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
}

.archive-status.migration {
    color: var(--bs-success);
}

.archive-status.backup {
    color: var(--bs-warning);
}

.archive-status.cleanup {
    color: var(--bs-info);
}

.archive-status.error {
    color: var(--bs-danger);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .timeline {
        padding-left: 1rem;
    }
    
    .timeline::before {
        left: 0.5rem;
    }
    
    .timeline-item::before {
        left: -1.25rem;
    }
    
    .archive-card {
        margin-bottom: 1rem;
    }
    
    .table-responsive table th,
    .table-responsive table td {
        font-size: 0.875rem;
        white-space: nowrap;
    }
}

/* Print styles */
@media print {
    .archive-content pre {
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    .timeline-item {
        break-inside: avoid;
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}