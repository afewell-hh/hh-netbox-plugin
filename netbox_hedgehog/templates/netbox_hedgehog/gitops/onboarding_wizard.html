{% extends "netbox_hedgehog/base.html" %}
{% load static %}

{% block title %}GitOps Onboarding Wizard{% endblock %}

{% block header %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'netbox_hedgehog/css/hedgehog.css' %}">
{% endblock %}

{% block breadcrumbs %}
    <li class="breadcrumb-item"><a href="{% url 'plugins:netbox_hedgehog:fabric_list' %}">Fabrics</a></li>
    <li class="breadcrumb-item active">GitOps Onboarding</li>
{% endblock %}

{% block hedgehog_content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="mdi mdi-rocket-launch"></i>
                        GitOps File Management Onboarding
                    </h3>
                    <p class="text-muted mb-0">Setup GitOps file management for your Hedgehog network fabric</p>
                </div>
                
                <!-- Progress Indicator -->
                <div class="card-body pb-0">
                    <div class="onboarding-progress d-flex justify-content-between mb-4">
                        <div class="step active d-flex flex-column align-items-center" data-step="1">
                            <div class="step-circle">
                                <i class="mdi mdi-folder-cog"></i>
                            </div>
                            <small class="mt-2">Configure</small>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step d-flex flex-column align-items-center" data-step="2">
                            <div class="step-circle">
                                <i class="mdi mdi-file-search"></i>
                            </div>
                            <small class="mt-2">Detect</small>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step d-flex flex-column align-items-center" data-step="3">
                            <div class="step-circle">
                                <i class="mdi mdi-strategy"></i>
                            </div>
                            <small class="mt-2">Strategy</small>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step d-flex flex-column align-items-center" data-step="4">
                            <div class="step-circle">
                                <i class="mdi mdi-cog"></i>
                            </div>
                            <small class="mt-2">Process</small>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step d-flex flex-column align-items-center" data-step="5">
                            <div class="step-circle">
                                <i class="mdi mdi-check-circle"></i>
                            </div>
                            <small class="mt-2">Complete</small>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Step 1: GitOps Directory Configuration -->
                    <div class="wizard-step" id="step-1">
                        <h4><i class="mdi mdi-folder-cog text-primary"></i> GitOps Directory Configuration</h4>
                        <p class="text-muted">Configure the GitOps directory path within your repository where Hedgehog will manage network configuration files.</p>
                        
                        <form id="gitops-config-form" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="gitops-directory" class="form-label">
                                            GitOps Directory Path
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-folder"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="gitops-directory" 
                                                   name="gitops_directory"
                                                   value="/fabrics/production/gitops"
                                                   placeholder="/fabrics/production/gitops"
                                                   required>
                                        </div>
                                        <div class="form-text">
                                            Path within your repository where GitOps files will be managed (e.g., /fabrics/prod/gitops)
                                        </div>
                                        <div class="invalid-feedback">
                                            Please provide a valid GitOps directory path.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="fabric-selector" class="form-label">Target Fabric</label>
                                        <select class="form-select" id="fabric-selector" name="fabric_id">
                                            <option value="">Select a fabric...</option>
                                            <!-- Fabrics will be populated via JavaScript -->
                                        </select>
                                        <div class="form-text">Choose the fabric to configure for GitOps</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="raw-directory" class="form-label">Raw Files Directory</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-file-multiple"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="raw-directory" 
                                                   name="raw_directory"
                                                   value="raw/"
                                                   placeholder="raw/">
                                        </div>
                                        <div class="form-text">Directory for unprocessed YAML files</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="managed-directory" class="form-label">Managed Files Directory</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="mdi mdi-folder-cog"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="managed-directory" 
                                                   name="managed_directory"
                                                   value="managed/"
                                                   placeholder="managed/">
                                        </div>
                                        <div class="form-text">Directory for processed and organized files</div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-primary" id="configure-next-btn">
                                    Next: Detect Files
                                    <i class="mdi mdi-arrow-right"></i>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Step 2: Existing File Detection -->
                    <div class="wizard-step d-none" id="step-2">
                        <h4><i class="mdi mdi-file-search text-warning"></i> Existing File Detection</h4>
                        <p class="text-muted">Scanning for existing YAML files in the GitOps directory...</p>
                        
                        <!-- Scanning Progress -->
                        <div id="scanning-progress" class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Scanning...</span>
                                </div>
                                <span>Scanning directory structure...</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- File Detection Results -->
                        <div id="file-detection-results" class="d-none">
                            <!-- Warning for existing files -->
                            <div class="alert alert-warning hedgehog-hidden" id="existing-files-warning">
                                <h5><i class="mdi mdi-alert"></i> Existing Files Detected</h5>
                                <p>Found <strong id="file-count">0</strong> YAML files in the GitOps directory.</p>
                                <p>These files will be:</p>
                                <ul>
                                    <li>Parsed and normalized into individual resource files</li>
                                    <li>Organized in the managed/ directory structure</li>
                                    <li>Original files moved to archive with timestamps</li>
                                </ul>
                                <button class="btn btn-info btn-sm" onclick="showFilePreview()">
                                    <i class="mdi mdi-eye"></i> Preview Files
                                </button>
                            </div>

                            <!-- No files found -->
                            <div class="alert alert-info hedgehog-hidden" id="no-files-found">
                                <h5><i class="mdi mdi-information"></i> Clean Directory</h5>
                                <p>No existing YAML files were found in the GitOps directory. The onboarding process will create the initial directory structure.</p>
                            </div>

                            <!-- File listing -->
                            <div id="file-listing" class="mt-3 hedgehog-hidden">
                                <h6>Detected Files:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>File</th>
                                                <th>Type</th>
                                                <th>Size</th>
                                                <th>Resources</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detected-files-tbody">
                                            <!-- Files populated via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="detect-back-btn">
                                <i class="mdi mdi-arrow-left"></i> Back
                            </button>
                            <button type="button" class="btn btn-primary" id="detect-next-btn" disabled>
                                Next: Choose Strategy
                                <i class="mdi mdi-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Migration Strategy Selection -->
                    <div class="wizard-step d-none" id="step-3">
                        <h4><i class="mdi mdi-strategy text-info"></i> Migration Strategy</h4>
                        <p class="text-muted">Choose how to handle existing files during the GitOps setup process.</p>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card strategy-card border-2" data-strategy="organize">
                                    <div class="card-body text-center">
                                        <i class="mdi mdi-folder-move display-4 text-primary mb-3"></i>
                                        <h5>Organize & Migrate</h5>
                                        <p class="text-muted small">
                                            Parse existing files and organize them into the managed directory structure. 
                                            Original files are archived safely.
                                        </p>
                                        <div class="mt-3">
                                            <span class="badge bg-success">Recommended</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card strategy-card border-2" data-strategy="archive">
                                    <div class="card-body text-center">
                                        <i class="mdi mdi-archive display-4 text-warning mb-3"></i>
                                        <h5>Archive & Start Fresh</h5>
                                        <p class="text-muted small">
                                            Archive all existing files and start with a clean managed directory structure. 
                                            Requires manual resource recreation.
                                        </p>
                                        <div class="mt-3">
                                            <span class="badge bg-warning">Safe</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card strategy-card border-2" data-strategy="backup">
                                    <div class="card-body text-center">
                                        <i class="mdi mdi-backup-restore display-4 text-secondary mb-3"></i>
                                        <h5>Backup Only</h5>
                                        <p class="text-muted small">
                                            Create backups of existing files but leave them in place. 
                                            Setup GitOps alongside existing structure.
                                        </p>
                                        <div class="mt-3">
                                            <span class="badge bg-secondary">Conservative</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Strategy Details -->
                        <div id="strategy-details" class="mt-4 hedgehog-hidden">
                            <div class="alert alert-light border">
                                <h6 id="strategy-title">Strategy Details</h6>
                                <div id="strategy-description"></div>
                                <div class="mt-3">
                                    <h6>What will happen:</h6>
                                    <ul id="strategy-actions"></ul>
                                </div>
                            </div>
                        </div>

                        <!-- Confirmation -->
                        <div id="strategy-confirmation" class="mt-4 hedgehog-hidden">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirm-strategy">
                                <label class="form-check-label" for="confirm-strategy">
                                    I understand the implications of this migration strategy and want to proceed
                                </label>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="strategy-back-btn">
                                <i class="mdi mdi-arrow-left"></i> Back
                            </button>
                            <button type="button" class="btn btn-primary" id="strategy-next-btn" disabled>
                                Start Processing
                                <i class="mdi mdi-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Processing -->
                    <div class="wizard-step d-none" id="step-4">
                        <h4><i class="mdi mdi-cog text-primary"></i> Processing GitOps Setup</h4>
                        <p class="text-muted">Setting up GitOps file management system...</p>
                        
                        <!-- Processing Progress -->
                        <div class="processing-progress mb-4">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span id="processing-status">Initializing...</span>
                                <span id="processing-percentage">0%</span>
                            </div>
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="processing-progress-bar"
                                     role="progressbar" 
                                     style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Processing Log -->
                        <div class="processing-log">
                            <h6>Processing Log:</h6>
                            <div class="hedgehog-log-container hedgehog-height-300">
                                <div class="log-entries" id="processing-log">
                                    <!-- Log entries will be added via JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Error Display -->
                        <div class="alert alert-danger hedgehog-hidden" id="processing-error">
                            <h5><i class="mdi mdi-alert-circle"></i> Processing Error</h5>
                            <p id="error-message"></p>
                            <details>
                                <summary>Technical Details</summary>
                                <pre id="error-details"></pre>
                            </details>
                            <div class="mt-3">
                                <button class="btn btn-outline-danger" onclick="retryProcessing()">
                                    <i class="mdi mdi-reload"></i> Retry
                                </button>
                                <button class="btn btn-outline-secondary" onclick="skipStep()">
                                    <i class="mdi mdi-skip-next"></i> Skip & Continue
                                </button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="processing-back-btn" disabled>
                                <i class="mdi mdi-arrow-left"></i> Back
                            </button>
                            <button type="button" class="btn btn-primary" id="processing-next-btn" disabled>
                                View Results
                                <i class="mdi mdi-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: Completion -->
                    <div class="wizard-step d-none" id="step-5">
                        <h4><i class="mdi mdi-check-circle text-success"></i> GitOps Setup Complete</h4>
                        <p class="text-muted">Your GitOps file management system has been successfully configured.</p>
                        
                        <!-- Success Summary -->
                        <div class="alert alert-success">
                            <h5><i class="mdi mdi-check-circle"></i> Setup Successful</h5>
                            <p>GitOps file management has been configured for your fabric.</p>
                        </div>

                        <!-- Setup Summary -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title">
                                            <i class="mdi mdi-folder-cog"></i> Configuration Summary
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <th>GitOps Directory:</th>
                                                <td><code id="summary-gitops-dir"></code></td>
                                            </tr>
                                            <tr>
                                                <th>Raw Directory:</th>
                                                <td><code id="summary-raw-dir"></code></td>
                                            </tr>
                                            <tr>
                                                <th>Managed Directory:</th>
                                                <td><code id="summary-managed-dir"></code></td>
                                            </tr>
                                            <tr>
                                                <th>Strategy Used:</th>
                                                <td><span id="summary-strategy" class="badge"></span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title">
                                            <i class="mdi mdi-chart-bar"></i> Processing Results
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <th>Files Processed:</th>
                                                <td><span id="summary-files-processed">0</span></td>
                                            </tr>
                                            <tr>
                                                <th>Resources Created:</th>
                                                <td><span id="summary-resources-created">0</span></td>
                                            </tr>
                                            <tr>
                                                <th>Files Archived:</th>
                                                <td><span id="summary-files-archived">0</span></td>
                                            </tr>
                                            <tr>
                                                <th>Processing Time:</th>
                                                <td><span id="summary-processing-time">0s</span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Next Steps -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="card-title">
                                    <i class="mdi mdi-lightbulb"></i> Next Steps
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="mdi mdi-check-circle text-success"></i>
                                        GitOps file management is now active
                                    </li>
                                    <li class="mb-2">
                                        <i class="mdi mdi-folder-eye"></i>
                                        Monitor the raw/ directory for new files
                                    </li>
                                    <li class="mb-2">
                                        <i class="mdi mdi-sync"></i>
                                        Files will be automatically processed and organized
                                    </li>
                                    <li class="mb-2">
                                        <i class="mdi mdi-history"></i>
                                        Review the archive browser for backed up files
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'plugins:netbox_hedgehog:gitops_dashboard' %}" class="btn btn-info">
                                <i class="mdi mdi-view-dashboard"></i> View GitOps Dashboard
                            </a>
                            <div>
                                <a href="{% url 'plugins:netbox_hedgehog:archive_browser' %}" class="btn btn-outline-secondary me-2">
                                    <i class="mdi mdi-archive"></i> Archive Browser
                                </a>
                                <a href="{% url 'plugins:netbox_hedgehog:fabric_list' %}" class="btn btn-primary">
                                    <i class="mdi mdi-check"></i> Done
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="mdi mdi-file-document"></i> File Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="file-preview-content">
                    <!-- File content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block hedgehog_javascript %}
<script src="{% static 'netbox_hedgehog/js/gitops-onboarding.js' %}"></script>
<style>
/* GitOps Onboarding Wizard Styles */
.onboarding-progress {
    position: relative;
    padding: 0 2rem;
}

.step {
    position: relative;
    z-index: 2;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--bs-light);
    border: 2px solid var(--bs-border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--bs-secondary);
    transition: all 0.3s ease;
}

.step.active .step-circle {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.step.completed .step-circle {
    background-color: var(--bs-success);
    border-color: var(--bs-success);
    color: white;
}

.step-connector {
    flex: 1;
    height: 2px;
    background-color: var(--bs-border-color);
    margin: 0 -1rem;
    margin-top: 25px;
    z-index: 1;
}

.step.active ~ .step-connector,
.step.completed ~ .step-connector {
    background-color: var(--bs-success);
}

.strategy-card {
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
}

.strategy-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.strategy-card.selected {
    border-color: var(--bs-primary) !important;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}

.log-container {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}

.log-entry {
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.log-entry .badge {
    font-size: 0.7rem;
    min-width: 80px;
}

@media (max-width: 768px) {
    .onboarding-progress {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    
    .step-connector {
        width: 2px;
        height: 2rem;
        margin: -0.5rem 0;
    }
    
    .strategy-card {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}