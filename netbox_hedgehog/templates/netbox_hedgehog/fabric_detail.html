{% extends "base/layout.html" %}
{% load static %}

{% block title %}{{ object.name }} - Fabric Details{% endblock %}

{% block header %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'netbox_hedgehog/css/hedgehog.css' %}">
    <link rel="stylesheet" href="{% static 'netbox_hedgehog/css/fabric-detail-enhanced.css' %}">
    <link rel="stylesheet" href="{% static 'netbox_hedgehog/css/responsive-fabric.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Progressive Disclosure UI Styles */
        .progressive-dashboard { display: grid; gap: 1.5rem; margin-bottom: 2rem; }
        .dashboard-overview { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 12px; padding: 2rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }
        .status-cards { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 1.5rem;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; padding: 1.5rem; backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .status-card:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
        .status-card-title { font-size: 0.9rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-card-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; }
        .status-card-subtitle { font-size: 0.8rem; opacity: 0.8; }
        .quick-actions { display: flex; gap: 1rem; flex-wrap: wrap; }
        .quick-action-btn {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 0.75rem 1.5rem; border-radius: 6px; text-decoration: none;
            font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .quick-action-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; text-decoration: none; transform: translateY(-1px); }
        .dashboard-section {
            background: white; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; overflow: hidden;
        }
        .dashboard-section:hover { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12); }
        .section-toggle {
            background: #f8f9fa; border: none; border-bottom: 1px solid #e9ecef;
            padding: 1.25rem 1.5rem; margin: 0; width: 100%; text-align: left; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; font-weight: 600;
            font-size: 1.1rem; color: #495057; transition: all 0.3s ease; user-select: none;
        }
        .section-toggle:hover { background: #e9ecef; }
        .section-toggle.collapsed { border-bottom: none; }
        .section-icon { margin-right: 0.75rem; font-size: 1.2rem; }
        .section-title { flex: 1; }
        .toggle-icon { font-size: 1.2rem; transition: transform 0.3s ease; color: #6c757d; }
        .section-toggle.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section-content { padding: 1.5rem; transition: all 0.3s ease; max-height: none; overflow: visible; }
        .section-content.collapsed { max-height: 0; padding: 0 1.5rem; overflow: hidden; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .info-item { display: flex; flex-direction: column; gap: 0.5rem; }
        .info-label { font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { color: #212529; font-size: 1rem; }
        .status-indicator {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
            border-radius: 20px; font-size: 0.9rem; font-weight: 600;
        }
        .status-indicator.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-indicator.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-indicator.danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-indicator.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status-indicator.secondary { background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        
        /* Drift Detection Styles */
        .drift-spotlight {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white; border-radius: 12px; padding: 2rem;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);
            margin-bottom: 2rem;
        }
        .drift-spotlight.in-sync {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.2);
        }
        .drift-spotlight.critical {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
        }
        .drift-summary-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; margin-top: 1.5rem;
        }
        .drift-summary-card {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; padding: 1.5rem; text-align: center;
            transition: all 0.3s ease;
        }
        .drift-summary-card:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-2px); }
        .drift-summary-card-title { font-size: 0.9rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.5rem; }
        .drift-summary-card-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .drift-summary-card-subtitle { font-size: 0.8rem; opacity: 0.8; }
        .drift-actions {
            display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem;
        }
        .drift-action-btn {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 0.75rem 1.5rem; border-radius: 6px; text-decoration: none;
            font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .drift-action-btn:hover { background: rgba(255, 255, 255, 0.25); color: white; text-decoration: none; }
        .drift-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .drift-badge.critical { background: #dc3545; color: white; }
        .drift-badge.important { background: #fd7e14; color: white; }
        .drift-badge.minor { background: #ffc107; color: #212529; }
        .drift-badge.none { background: #198754; color: white; }
    </style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <h3 class="mb-2 mb-md-0"><i class="mdi mdi-server-network"></i> {{ object.name }}</h3>
                    <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto justify-content-end">
                        <a href="{% url 'plugins:netbox_hedgehog:fabric_list' %}" 
                           class="btn btn-outline-secondary"
                           aria-label="Return to fabric list">
                            <i class="mdi mdi-arrow-left d-md-inline d-none"></i>
                            <span class="d-md-none">←</span> Back to Fabrics
                        </a>
                        <a href="{% url 'plugins:netbox_hedgehog:fabric_edit' pk=object.pk %}" 
                           class="btn btn-outline-primary"
                           aria-label="Edit fabric configuration">
                            <i class="mdi mdi-pencil"></i> Edit
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Sync Status Summary -->
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <div class="card border-primary h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="mdi mdi-git"></i> Git Repository Sync</h5>
                                    <small class="d-block">Syncing FROM Git TO NetBox</small>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3">
                                        <div>
                                            <h6 class="mb-0">Status</h6>
                                            {% if object.git_repository_url %}
                                                {% if object.drift_status == 'in_sync' %}
                                                    <span class="badge bg-success">
                                                        <i class="mdi mdi-check-circle"></i> In Sync
                                                    </span>
                                                {% elif object.drift_status == 'drift_detected' %}
                                                    <span class="badge bg-warning">
                                                        <i class="mdi mdi-alert-circle"></i> Drift Detected
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="mdi mdi-help-circle"></i> Unknown
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="mdi mdi-git"></i> Not Configured
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if object.last_git_sync %}
                                                <small class="text-muted">Last sync: {{ object.last_git_sync|timesince }} ago</small>
                                            {% else %}
                                                <small class="text-muted">Never synced</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if object.git_repository_url %}
                                        <div class="mb-2">
                                            <small class="text-muted">Repository:</small><br>
                                            <a href="{{ object.git_repository_url }}" target="_blank" class="text-decoration-none">
                                                <i class="mdi mdi-open-in-new"></i> {{ object.git_repository_url|truncatechars:40 }}
                                            </a>
                                        </div>
                                        <button class="btn btn-sm btn-primary" 
                                               id="git-sync-from-repo-btn" 
                                               data-fabric-id="{{ object.pk }}" 
                                               aria-label="Synchronize fabric configuration from Git repository">
                                            <i class="mdi mdi-sync"></i> Sync from Git
                                        </button>
                                    {% else %}
                                        <p class="mb-2">Configure a Git repository to sync configuration from Git to NetBox.</p>
                                        <a href="{% url 'plugins:netbox_hedgehog:fabric_edit' pk=object.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="mdi mdi-git"></i> Configure Git
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <div class="card border-info h-100">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="mdi mdi-kubernetes"></i> HCKC (Kubernetes) Sync</h5>
                                    <small class="d-block">Syncing FROM NetBox TO Kubernetes</small>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3">
                                        <div>
                                            <h6 class="mb-0">Status</h6>
                                            {% if object.sync_status == 'in_sync' %}
                                                <span class="badge bg-success">
                                                    <i class="mdi mdi-check-circle"></i> In Sync
                                                </span>
                                            {% elif object.sync_status == 'syncing' %}
                                                <span class="badge bg-info">
                                                    <i class="mdi mdi-sync mdi-spin"></i> Syncing
                                                </span>
                                            {% elif object.sync_status == 'error' %}
                                                <span class="badge bg-danger">
                                                    <i class="mdi mdi-sync-alert"></i> Error
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="mdi mdi-sync-off"></i> Not Synced
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if object.last_sync %}
                                                <small class="text-muted">Last sync: {{ object.last_sync|timesince }} ago</small>
                                            {% else %}
                                                <small class="text-muted">Never synced</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Namespace:</small> <code>{{ object.kubernetes_namespace }}</code><br>
                                        <small class="text-muted">CRDs:</small> <strong>{{ object.cached_crd_count|default:0 }}</strong>
                                    </div>
                                    {% if object.sync_error %}
                                        <div class="alert alert-danger py-1 px-2 mb-2">
                                            <small>{{ object.sync_error|truncatechars:100 }}</small>
                                        </div>
                                    {% endif %}
                                    <button id="sync-now-btn" 
                                           class="btn btn-sm btn-info" 
                                           data-fabric-id="{{ object.pk }}"
                                           aria-label="Synchronize fabric configuration to Kubernetes cluster">
                                        <i class="mdi mdi-sync"></i> Sync to Kubernetes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Drift Detection Section -->
                    {% if object.git_repository_url %}
                    <div class="drift-spotlight {% if drift_summary.status == 'in_sync' %}in-sync{% elif drift_summary.severity == 'critical' %}critical{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h4 class="mb-2">
                                    <i class="mdi mdi-compare-horizontal"></i> 
                                    Drift Detection Status
                                </h4>
                                <p class="mb-0 opacity-90">
                                    {% if drift_summary.status == 'in_sync' %}
                                        Your fabric configuration is perfectly synchronized with Git repository.
                                    {% elif drift_summary.count > 0 %}
                                        Configuration drift detected. {{ drift_summary.count }} resource{{ drift_summary.count|pluralize }} need attention.
                                    {% else %}
                                        Drift detection is active and monitoring your fabric configuration.
                                    {% endif %}
                                </p>
                            </div>
                            <div class="text-end">
                                <span class="drift-badge {{ drift_summary.severity }}">
                                    {% if drift_summary.status == 'in_sync' %}
                                        <i class="mdi mdi-check-circle"></i> In Sync
                                    {% elif drift_summary.count > 0 %}
                                        <i class="mdi mdi-alert-circle"></i> {{ drift_summary.count }} Drift{{ drift_summary.count|pluralize }}
                                    {% else %}
                                        <i class="mdi mdi-help-circle"></i> {{ drift_summary.status|title }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="drift-summary-cards">
                            <div class="drift-summary-card">
                                <div class="drift-summary-card-title">RESOURCES WITH DRIFT</div>
                                <div class="drift-summary-card-value">{{ drift_summary.count }}</div>
                                <div class="drift-summary-card-subtitle">
                                    of {{ drift_summary.total_resources }} total
                                </div>
                            </div>
                            <div class="drift-summary-card">
                                <div class="drift-summary-card-title">LAST CHECK</div>
                                <div class="drift-summary-card-value">
                                    {% if drift_summary.last_check %}
                                        {{ drift_summary.last_check|timesince|truncatewords:1 }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </div>
                                <div class="drift-summary-card-subtitle">
                                    {% if drift_summary.last_check %}ago{% else %}checked{% endif %}
                                </div>
                            </div>
                            <div class="drift-summary-card">
                                <div class="drift-summary-card-title">SEVERITY</div>
                                <div class="drift-summary-card-value">
                                    {% if drift_summary.severity == 'critical' %}
                                        <i class="mdi mdi-alert-octagon"></i>
                                    {% elif drift_summary.severity == 'important' %}
                                        <i class="mdi mdi-alert-circle"></i>
                                    {% elif drift_summary.severity == 'minor' %}
                                        <i class="mdi mdi-alert"></i>
                                    {% else %}
                                        <i class="mdi mdi-check-circle"></i>
                                    {% endif %}
                                </div>
                                <div class="drift-summary-card-subtitle">
                                    {{ drift_summary.severity|title }}{% if drift_summary.severity == 'none' %} Issues{% endif %}
                                </div>
                            </div>
                            <div class="drift-summary-card">
                                <div class="drift-summary-card-title">STATUS</div>
                                <div class="drift-summary-card-value">
                                    {% if object.drift_status == 'in_sync' %}
                                        <i class="mdi mdi-check-bold"></i>
                                    {% elif object.drift_status == 'drift_detected' %}
                                        <i class="mdi mdi-sync-alert"></i>
                                    {% else %}
                                        <i class="mdi mdi-help-circle"></i>
                                    {% endif %}
                                </div>
                                <div class="drift-summary-card-subtitle">
                                    {{ object.get_drift_status_display|default:object.drift_status|title }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="drift-actions">
                            {% if drift_summary.count > 0 %}
                                <button class="drift-action-btn" 
                                       data-fabric-id="{{ object.pk }}"
                                       aria-label="Analyze configuration drift details">
                                    <i class="mdi mdi-chart-line"></i> Analyze Drift
                                </button>
                                <button class="drift-action-btn" 
                                       data-fabric-id="{{ object.pk }}"
                                       id="drift-sync-from-git-btn"
                                       aria-label="Synchronize from Git to resolve drift">
                                    <i class="mdi mdi-sync"></i> Sync from Git
                                </button>
                            {% else %}
                                <button class="drift-action-btn" 
                                       data-fabric-id="{{ object.pk }}"
                                       id="check-drift-btn"
                                       aria-label="Check for configuration drift">
                                    <i class="mdi mdi-magnify"></i> Check for Drift
                                </button>
                                <button class="drift-action-btn" 
                                       data-fabric-id="{{ object.pk }}"
                                       id="drift-history-btn"
                                       aria-label="View drift detection history">
                                    <i class="mdi mdi-history"></i> View History
                                </button>
                            {% endif %}
                            <button class="drift-action-btn" 
                                   data-fabric-id="{{ object.pk }}"
                                   id="drift-config-btn"
                                   aria-label="Configure drift detection settings">
                                <i class="mdi mdi-cog"></i> Configure Detection
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row g-4">
                        <div class="col-12 col-lg-8">
                            <h4 class="readable-text">Fabric Information</h4>
                            <div class="table-responsive">
                                <table class="table table-borderless fabric-detail">
                                <tr>
                                    <th width="200">Name:</th>
                                    <td>{{ object.name }}</td>
                                </tr>
                                <tr>
                                    <th>Description:</th>
                                    <td>{{ object.description|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <th>Configuration Status:</th>
                                    <td>
                                        <span class="badge bg-{% if object.status == 'active' %}success{% elif object.status == 'maintenance' %}warning{% else %}secondary{% endif %}">
                                            {{ object.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                
                                <!-- Git Repository Sync Details -->
                                <tr class="table-active">
                                    <th colspan="2" class="bg-light">
                                        <i class="mdi mdi-git text-primary"></i> Git Repository Sync (Git → NetBox)
                                    </th>
                                </tr>
                                <tr>
                                    <th>Git Sync Status:</th>
                                    <td>
                                        {% if object.git_repository_url %}
                                            {% if object.drift_status == 'in_sync' %}
                                                <span class="badge bg-success fs-6 px-3 py-2">
                                                    <i class="mdi mdi-check-circle"></i> In Sync
                                                </span>
                                                <span class="text-success ms-2">
                                                    <i class="mdi mdi-shield-check"></i> Configuration synchronized
                                                </span>
                                            {% elif object.drift_status == 'drift_detected' %}
                                                <span class="badge bg-warning fs-6 px-3 py-2">
                                                    <i class="mdi mdi-alert-circle"></i> Drift Detected
                                                </span>
                                                <span class="text-warning ms-2">
                                                    <i class="mdi mdi-compare-horizontal"></i> {{ object.drift_count }} resource{{ object.drift_count|pluralize }} with drift
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary fs-6 px-3 py-2">
                                                    <i class="mdi mdi-help-circle"></i> Unknown
                                                </span>
                                                <span class="text-muted ms-2">Status unknown</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary fs-6 px-3 py-2">
                                                <i class="mdi mdi-git"></i> Not Configured
                                            </span>
                                            <span class="text-muted ms-2">No Git repository configured</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Last Git Sync:</th>
                                    <td>
                                        {% if object.last_git_sync %}
                                            {{ object.last_git_sync }} ({{ object.last_git_sync|timesince }} ago)
                                        {% else %}
                                            <span class="text-muted">Never synchronized from Git</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <!-- Kubernetes Sync Details -->
                                <tr class="table-active">
                                    <th colspan="2" class="bg-light">
                                        <i class="mdi mdi-kubernetes text-info"></i> HCKC Sync (NetBox → Kubernetes)
                                    </th>
                                </tr>
                                <tr>
                                    <th>HCKC Sync Status:</th>
                                    <td>
                                        {% if object.sync_status == 'in_sync' %}
                                            <span class="badge bg-success" data-sync-status><i class="mdi mdi-check-circle"></i> In Sync</span>
                                        {% elif object.sync_status == 'out_of_sync' %}
                                            <span class="badge bg-warning" data-sync-status><i class="mdi mdi-alert"></i> Out of Sync</span>
                                        {% elif object.sync_status == 'syncing' %}
                                            <span class="badge bg-info" data-sync-status><i class="mdi mdi-sync mdi-spin"></i> Syncing</span>
                                        {% elif object.sync_status == 'error' %}
                                            <span class="badge bg-danger" data-sync-status><i class="mdi mdi-sync-alert"></i> Sync Error</span>
                                        {% else %}
                                            <span class="badge bg-secondary" data-sync-status><i class="mdi mdi-sync-off"></i> Never Synced</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Last HCKC Sync:</th>
                                    <td>
                                        {% if object.last_sync %}
                                            {{ object.last_sync }} ({{ object.last_sync|timesince }} ago)
                                        {% else %}
                                            <span class="text-muted">Never synchronized to Kubernetes</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Connection Status:</th>
                                    <td>
                                        {% if object.connection_status == 'connected' %}
                                            <span class="badge bg-success" data-connection-status><i class="mdi mdi-lan-connect"></i> Connected</span>
                                        {% elif object.connection_status == 'disconnected' %}
                                            <span class="badge bg-danger" data-connection-status><i class="mdi mdi-lan-disconnect"></i> Disconnected</span>
                                        {% elif object.connection_status == 'error' %}
                                            <span class="badge bg-danger" data-connection-status><i class="mdi mdi-alert"></i> Error</span>
                                        {% else %}
                                            <span class="badge bg-secondary" data-connection-status><i class="mdi mdi-help-circle"></i> Unknown</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Kubernetes Namespace:</th>
                                    <td><code>{{ object.kubernetes_namespace }}</code></td>
                                </tr>
                                <tr>
                                    <th>Kubernetes Server:</th>
                                    <td>
                                        {% if object.kubernetes_server and object.kubernetes_server|length > 0 %}
                                            <code>{{ object.kubernetes_server }}</code>
                                        {% else %}
                                            <span class="text-muted">Not configured</span>
                                            <small class="text-muted ms-2">(Using default kubeconfig)</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Sync Enabled:</th>
                                    <td>
                                        {% if object.sync_enabled %}
                                            <span class="badge bg-success">Enabled</span>
                                            ({{ object.sync_interval }}s interval)
                                        {% else %}
                                            <span class="badge bg-secondary">Disabled</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if object.sync_error %}
                                <tr>
                                    <th>Sync Error:</th>
                                    <td>
                                        <div class="alert alert-danger mb-0">
                                            <small>{{ object.sync_error }}</small>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                
                                <!-- GitOps Integration -->
                                {% if object.git_repository_url %}
                                <tr>
                                    <th>Git Repository:</th>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="mdi mdi-git me-2"></i>
                                            <a href="{{ object.git_repository_url }}" target="_blank" class="text-decoration-none">
                                                {{ object.git_repository_url|truncatechars:50 }}
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Git Branch:</th>
                                    <td><code>{{ object.git_branch|default:"main" }}</code></td>
                                </tr>
                                <tr>
                                    <th>GitOps Operations:</th>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="triggerGitSync()">
                                                <i class="mdi mdi-git"></i> Sync from Git
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="showResourceStates()">
                                                <i class="mdi mdi-view-list"></i> Resource States
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="showDriftDetails()">
                                                <i class="mdi mdi-compare-horizontal"></i> Drift Details
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Desired State Commit:</th>
                                    <td>
                                        {% if object.desired_state_commit %}
                                            <code>{{ object.desired_state_commit|truncatechars:12 }}</code>
                                        {% else %}
                                            <span class="text-muted">No commit tracked</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <th>GitOps Status:</th>
                                    <td>
                                        <span class="badge bg-secondary">
                                            <i class="mdi mdi-git"></i> Not Connected
                                        </span>
                                        <div class="mt-2">
                                            <span class="text-muted">GitOps onboarding not configured</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-12 col-lg-4">
                            <h4>Statistics</h4>
                            <div class="row g-3">
                                <div class="col-6 col-sm-12 col-lg-6">
                                    <div class="card bg-info text-white text-center h-100">
                                        <div class="card-body">
                                            <h3 data-crd-count>{{ object.crd_count }}</h3>
                                            <small>Total CRDs</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-12 col-lg-6">
                                    <div class="card bg-success text-white text-center h-100">
                                        <div class="card-body">
                                            <h3>{{ object.active_crd_count }}</h3>
                                            <small>Active CRDs</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-12 col-lg-6">
                                    <div class="card bg-danger text-white text-center h-100">
                                        <div class="card-body">
                                            <h3>{{ object.error_crd_count }}</h3>
                                            <small>Error CRDs</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-12 col-lg-6">
                                    <div class="card bg-warning text-white text-center h-100">
                                        <div class="card-body">
                                            <h3>0</h3>
                                            <small>Pending</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h5>Actions</h5>
                                <div class="d-grid gap-2">
                                    <button id="test-connection-btn" 
                                           class="btn btn-outline-info" 
                                           data-fabric-id="{{ object.pk }}"
                                           aria-label="Test connection to Kubernetes cluster">
                                        <i class="mdi mdi-test-tube"></i> Test Connection
                                    </button>
                                    <button id="sync-now-btn" 
                                           class="btn btn-primary" 
                                           data-fabric-id="{{ object.pk }}"
                                           aria-label="Synchronize fabric configuration now">
                                        <i class="mdi mdi-sync"></i> Sync Now
                                    </button>
                                    {% if object.crd_count > 0 %}
                                    <a href="{% url 'plugins:netbox_hedgehog:connection_list' %}" class="btn btn-info" title="View imported CRDs ({{ object.crd_count }} total)">
                                        <i class="mdi mdi-eye"></i> View CRDs ({{ object.crd_count }})
                                    </a>
                                    {% else %}
                                    <button class="btn btn-outline-info" disabled title="No CRDs imported yet. Run sync first.">
                                        <i class="mdi mdi-eye"></i> View CRDs (0)
                                    </button>
                                    {% endif %}
                                    
                                    <button class="btn btn-warning" disabled>
                                        <i class="mdi mdi-cog"></i> Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GitOps Configuration Section (MVP2 Enhancement) -->
                    <div class="gitops-detail-section">
                        <h4 class="readable-text"><i class="mdi mdi-git"></i> GitOps Configuration</h4>
                        <div class="row">
                            <div class="col-md-8">
                                <table class="table table-borderless">
                                    <tr>
                                        <th>Git Repository:</th>
                                        <td>
                                            {% if object.git_repository_url %}
                                                <a href="{{ object.git_repository_url }}" target="_blank" class="text-decoration-none">
                                                    <i class="mdi mdi-open-in-new"></i> {{ object.git_repository_url }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">
                                                    <i class="mdi mdi-git"></i> Not configured
                                                </span>
                                                <a href="{% url 'plugins:netbox_hedgehog:fabric_edit' pk=object.pk %}" class="btn btn-sm btn-outline-primary ms-2">
                                                    <i class="mdi mdi-plus"></i> Configure Git
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% if object.git_repository_url %}
                                    <tr>
                                        <th>Branch:</th>
                                        <td><code class="bg-light px-2 py-1 rounded">{{ object.git_branch }}</code></td>
                                    </tr>
                                    <tr>
                                        <th>Path:</th>
                                        <td><code class="bg-light px-2 py-1 rounded">{{ object.git_path }}</code></td>
                                    </tr>
                                    <tr>
                                        <th>Drift Status:</th>
                                        <td>
                                            <span class="gitops-status-indicator {% if object.drift_count > 0 %}has-drift{% endif %}">
                                                <span class="badge bg-{% if object.drift_status == 'in_sync' %}success{% elif object.drift_status == 'drift_detected' %}warning{% else %}secondary{% endif %} fs-6 px-3 py-2">
                                                    <i class="mdi mdi-{% if object.drift_status == 'in_sync' %}check-circle{% elif object.drift_status == 'drift_detected' %}alert-circle{% else %}help-circle{% endif %}"></i>
                                                    {{ object.get_drift_status_display|default:object.drift_status|title }}
                                                </span>
                                            </span>
                                            {% if object.drift_count > 0 %}
                                                <div class="mt-2">
                                                    <span class="text-warning fw-bold">
                                                        <i class="mdi mdi-compare-horizontal"></i> 
                                                        {{ object.drift_count }} resource{{ object.drift_count|pluralize }} with configuration drift
                                                    </span>
                                                    <button class="btn btn-sm btn-outline-warning ms-2" 
                                                           data-fabric-id="{{ object.pk }}"
                                                           id="inline-drift-analysis-btn"
                                                           aria-label="Analyze configuration drift">
                                                        <i class="mdi mdi-chart-line"></i> Analyze
                                                    </button>
                                                </div>
                                            {% else %}
                                                <span class="text-success ms-2">
                                                    <i class="mdi mdi-shield-check"></i> All resources synchronized
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Last Git Sync:</th>
                                        <td>
                                            {% if object.last_git_sync %}
                                                <span title="{{ object.last_git_sync }}">
                                                    <i class="mdi mdi-clock-outline"></i> {{ object.last_git_sync|timesince }} ago
                                                </span>
                                            {% else %}
                                                <span class="text-muted">
                                                    <i class="mdi mdi-sync-alert"></i> Never synchronized
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Current Commit:</th>
                                        <td>
                                            {% if object.desired_state_commit %}
                                                <code class="bg-light px-2 py-1 rounded">{{ object.desired_state_commit|truncatechars:12 }}</code>
                                                {% if object.git_repository_url %}
                                                    <a href="{{ object.git_repository_url|add:'/commit/'|add:object.desired_state_commit }}" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                                        <i class="mdi mdi-open-in-new"></i> View Commit
                                                    </a>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Unknown</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                            
                            <div class="col-md-4">
                                <h5>GitOps Actions</h5>
                                <div class="d-grid gap-2">
                                    {% if object.git_repository_url %}
                                        <button id="git-sync-btn" 
                                               class="btn btn-primary" 
                                               data-fabric-id="{{ object.pk }}"
                                               aria-label="Synchronize configuration from Git repository">
                                            <i class="mdi mdi-sync"></i> Sync from Git
                                        </button>
                                        {% if object.drift_count > 0 %}
                                            <button id="drift-report-btn" 
                                                   class="btn btn-warning" 
                                                   data-fabric-id="{{ object.pk }}"
                                                   aria-label="View detailed drift analysis report">
                                                <i class="mdi mdi-alert-circle"></i> View Drift Report
                                            </button>
                                        {% endif %}
                                        <button id="git-status-btn" 
                                               class="btn btn-info" 
                                               data-fabric-id="{{ object.pk }}"
                                               aria-label="Check Git repository status">
                                            <i class="mdi mdi-information"></i> Git Status
                                        </button>
                                    {% else %}
                                        <a href="{% url 'plugins:netbox_hedgehog:fabric_edit' pk=object.pk %}" class="btn btn-primary">
                                            <i class="mdi mdi-git"></i> Configure Git Repository
                                        </a>
                                        <div class="alert alert-info mb-0 small">
                                            <i class="mdi mdi-information"></i>
                                            Configure a Git repository to enable GitOps features like drift detection and automated synchronization.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GitOps File Management Section -->
                    {% if object.git_repository_url %}
                    <div class="gitops-file-management-section mt-4">
                        <h4><i class="mdi mdi-folder-cog text-primary"></i> GitOps File Management</h4>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="mdi mdi-file-multiple"></i> File Processing Status
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="card bg-warning text-white">
                                                    <div class="card-body">
                                                        <h4 id="raw-files-count">0</h4>
                                                        <small>Raw Files</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-info text-white">
                                                    <div class="card-body">
                                                        <h4 id="processing-files-count">0</h4>
                                                        <small>Processing</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-success text-white">
                                                    <div class="card-body">
                                                        <h4 id="managed-files-count">0</h4>
                                                        <small>Managed</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-secondary text-white">
                                                    <div class="card-body">
                                                        <h4 id="archived-files-count">0</h4>
                                                        <small>Archived</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6>Recent File Activity</h6>
                                            <div class="file-activity-log hedgehog-scrollable-200">
                                                <div class="text-muted text-center py-3" id="no-activity">
                                                    <i class="mdi mdi-clock-outline"></i>
                                                    <p class="mb-0">No recent file activity</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="mdi mdi-cog"></i> File Management
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <div class="text-muted">GitOps file management tools not available</div>
                                            <button class="btn btn-primary" 
                                                   data-fabric-id="{{ object.pk }}"
                                                   id="process-files-btn"
                                                   aria-label="Process all GitOps files for this fabric">
                                                <i class="mdi mdi-play"></i> Process All Files
                                            </button>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <h6>Processing Settings</h6>
                                            <div class="processing-settings">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span>Auto Processing:</span>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="auto-processing" checked aria-label="Enable automatic file processing">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span>File Validation:</span>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="file-validation" checked aria-label="Enable file validation">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span>Create Backups:</span>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="create-backups" checked aria-label="Create backups before processing">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="mdi mdi-chart-pie"></i> Storage Usage
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="storage-breakdown">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="d-flex align-items-center">
                                                    <div class="storage-color-indicator bg-warning me-2"></div>
                                                    <span>Raw Files</span>
                                                </div>
                                                <span id="raw-storage-size" class="fw-bold">0 MB</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div class="d-flex align-items-center">
                                                    <div class="storage-color-indicator bg-success me-2"></div>
                                                    <span>Managed Files</span>
                                                </div>
                                                <span id="managed-storage-size" class="fw-bold">0 MB</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <div class="storage-color-indicator bg-secondary me-2"></div>
                                                    <span>Archives</span>
                                                </div>
                                                <span id="archive-storage-size" class="fw-bold">0 MB</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-warning w-100" 
                                                   data-fabric-id="{{ object.pk }}"
                                                   id="optimize-storage-btn"
                                                   aria-label="Optimize GitOps storage and clean up old files">
                                                <i class="mdi mdi-speedometer"></i> Optimize Storage
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="gitops-file-management-section mt-4">
                        <h4><i class="mdi mdi-folder-cog text-muted"></i> GitOps File Management</h4>
                        <div class="alert alert-info">
                            <h5><i class="mdi mdi-information"></i> GitOps Not Configured</h5>
                            <p>GitOps file management features are available once you configure a Git repository for this fabric.</p>
                            <div class="mt-3">
                                <span class="text-muted">GitOps setup not available</span>
                                <span class="text-muted ms-2">GitOps dashboard not available</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <h4>Configuration Details</h4>
                    <div class="alert alert-info">
                        <h5><i class="mdi mdi-information"></i> Demo Mode</h5>
                        <p>In the full version, this section would show:</p>
                        <ul>
                            <li>Kubernetes connection status and details</li>
                            <li>CRD management interface</li>
                            <li>Sync logs and history</li>
                            <li>Configuration management tools</li>
                            <li>Real-time status monitoring</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="{% static 'netbox_hedgehog/js/responsive-enhancements.js' %}"></script>
<script src="{% static 'netbox_hedgehog/js/sync-handler.js' %}?v={{ "now"|date:"U" }}"></script>
<script src="{% static 'netbox_hedgehog/js/emergency-sync-fix.js' %}?v={{ "now"|date:"U" }}"></script>
<script type="text/javascript">
// Use safe ready function to prevent errors
window.safeReady(function() {
    console.log('🚀 Fabric detail JavaScript loading...');
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('❌ CSRF token not found');
        return;
    }
    console.log('✅ CSRF token found');
    
    // Get buttons (MVP1 + MVP2)
    const testBtn = document.getElementById('test-connection-btn');
    const syncBtn = document.getElementById('sync-now-btn');
    const gitSyncBtn = document.getElementById('git-sync-btn');
    const driftReportBtn = document.getElementById('drift-report-btn');
    const gitStatusBtn = document.getElementById('git-status-btn');
    console.log('✅ Found buttons:', {
        testBtn: !!testBtn, 
        syncBtn: !!syncBtn, 
        gitSyncBtn: !!gitSyncBtn,
        driftReportBtn: !!driftReportBtn,
        gitStatusBtn: !!gitStatusBtn
    });
    
    // Test Connection functionality
    if (testBtn) {
        testBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const fabricId = this.getAttribute('data-fabric-id');
            console.log('🔍 Test Connection clicked for fabric:', fabricId);
            
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Testing...';
            this.disabled = true;
            
            // Make API call
            fetch(`/plugins/hedgehog/fabrics/${fabricId}/test-connection/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('📡 Test connection response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('✅ Test connection response:', data);
                if (data.success) {
                    this.innerHTML = '<i class="mdi mdi-check"></i> Connected!';
                    this.className = 'btn btn-success';
                    const successMessage = 'Connection test successful!';
                    if (window.Hedgehog && window.Hedgehog.utils && window.Hedgehog.utils.showNotification) {
                        window.Hedgehog.utils.showNotification(successMessage, 'success');
                    } else {
                        alert(successMessage);
                    }
                    // Reload page to show updated status
                    setTimeout(() => location.reload(), 2000);
                } else {
                    this.innerHTML = '<i class="mdi mdi-close"></i> Failed';
                    this.className = 'btn btn-danger';
                    alert('Connection test failed: ' + (data.error || 'Unknown error'));
                    // Reset button after delay
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.className = 'btn btn-outline-info';
                        this.disabled = false;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('❌ Test connection error:', error);
                this.innerHTML = '<i class="mdi mdi-close"></i> Error';
                this.className = 'btn btn-danger';
                alert('Connection test failed: ' + error.message);
                // Reset button after delay
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.className = 'btn btn-outline-info';
                    this.disabled = false;
                }, 3000);
            });
        });
    }
    
    // Sync functionality
    if (syncBtn) {
        syncBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const fabricId = this.getAttribute('data-fabric-id');
            console.log('🔄 Sync Now clicked for fabric:', fabricId);
            
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Syncing...';
            this.disabled = true;
            
            // Make API call
            fetch(`/plugins/hedgehog/fabrics/${fabricId}/sync/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('📡 Sync response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('✅ Sync response:', data);
                if (data.success) {
                    this.innerHTML = '<i class="mdi mdi-check"></i> Synchronized!';
                    this.className = 'btn btn-success';
                    const successMessage = 'Sync completed successfully!';
                    if (window.Hedgehog && window.Hedgehog.utils && window.Hedgehog.utils.showNotification) {
                        window.Hedgehog.utils.showNotification(successMessage, 'success');
                    } else {
                        alert(successMessage);
                    }
                    // Reset button after delay
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.className = 'btn btn-primary';
                        this.disabled = false;
                    }, 3000);
                } else {
                    this.innerHTML = '<i class="mdi mdi-close"></i> Failed';
                    this.className = 'btn btn-danger';
                    alert('Sync failed: ' + (data.error || 'Unknown error'));
                    // Reset button after delay
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.className = 'btn btn-primary';
                        this.disabled = false;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('❌ Sync error:', error);
                this.innerHTML = '<i class="mdi mdi-close"></i> Error';
                this.className = 'btn btn-danger';
                alert('Sync failed: ' + error.message);
                // Reset button after delay
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.className = 'btn btn-primary';
                    this.disabled = false;
                }, 3000);
            });
        });
    }
    
    // GitOps functionality (MVP2)
    if (gitSyncBtn) {
        gitSyncBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const fabricId = this.getAttribute('data-fabric-id');
            console.log('🔄 Git Sync clicked for fabric:', fabricId);
            
            // Use UnifiedSync if available
            if (window.UnifiedSync && window.UnifiedSync.sync) {
                console.log('Using UnifiedSync for Git sync button');
                window.UnifiedSync.sync(fabricId, this);
            } else {
                console.warn('UnifiedSync not available, using inline implementation');
                
                // Fallback implementation with cache-busting
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Syncing from Git...';
                this.disabled = true;
                
                const timestamp = Date.now();
                fetch(`http://vlab-art-2.l.hhdev.io:8004/plugins/hedgehog/api/fabrics/${fabricId}/gitops/sync/?_cb=${timestamp}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken.value,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    credentials: 'same-origin',
                    cache: 'no-store'
                })
                .then(response => {
                    console.log('📡 Git sync response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('✅ Git sync response:', data);
                    if (data.success) {
                        this.innerHTML = '<i class="mdi mdi-check"></i> Synced from Git!';
                        this.className = 'btn btn-success';
                        
                        // Show success notification
                        showNotification('Git sync completed successfully!', 'success');
                        
                        // Reload page to show updated status
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        this.innerHTML = '<i class="mdi mdi-close"></i> Sync Failed';
                        this.className = 'btn btn-danger';
                        showNotification('Git sync failed: ' + (data.error || 'Unknown error'), 'error');
                        
                        // Reset button after delay
                        setTimeout(() => {
                            this.innerHTML = originalText;
                            this.className = 'btn btn-primary';
                            this.disabled = false;
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('❌ Git sync error:', error);
                    this.innerHTML = '<i class="mdi mdi-close"></i> Error';
                    this.className = 'btn btn-danger';
                    showNotification('Git sync failed: ' + error.message, 'error');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.className = 'btn btn-primary';
                        this.disabled = false;
                    }, 3000);
                });
            }
        });
    }
    
    if (driftReportBtn) {
        driftReportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const fabricId = this.getAttribute('data-fabric-id');
            console.log('📊 Drift Report clicked for fabric:', fabricId);
            
            // Make API call for drift report using safe fetch
            window.safeFetch(`/api/plugins/hedgehog/gitops-fabrics/${fabricId}/drift_report/`, {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ Drift report response:', data);
                showDriftModal(data);
            })
            .catch(error => {
                console.error('❌ Drift report error:', error);
                showNotification('Failed to load drift report: ' + error.message, 'error');
            });
        });
    }
    
    if (gitStatusBtn) {
        gitStatusBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const fabricId = this.getAttribute('data-fabric-id');
            console.log('📈 Git Status clicked for fabric:', fabricId);
            
            // Make API call for Git status using safe fetch
            window.safeFetch(`/api/plugins/hedgehog/gitops-fabrics/${fabricId}/git_status/`, {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ Git status response:', data);
                showGitStatusModal(data);
            })
            .catch(error => {
                console.error('❌ Git status error:', error);
                showNotification('Failed to load Git status: ' + error.message, 'error');
            });
        });
    }
    
    // Utility functions for GitOps features
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="mdi mdi-${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    function showDriftModal(data) {
        // Create and show drift analysis modal
        const modalHtml = `
            <div class="modal fade" id="driftModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="mdi mdi-alert-circle text-warning"></i>
                                Drift Analysis Report
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-4 text-center">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body">
                                            <h3>${data.drift_count || 0}</h3>
                                            <small>Resources with Drift</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h3>${data.total_resources || 0}</h3>
                                            <small>Total Resources</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="card bg-secondary text-white">
                                        <div class="card-body">
                                            <h3>${data.last_calculated ? 'Recent' : 'Never'}</h3>
                                            <small>Last Check</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Detailed Analysis</h6>
                                <p class="text-muted">${data.details || 'No detailed analysis available'}</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="location.reload()">Refresh Status</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if present
        const existingModal = document.getElementById('driftModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body and show
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('driftModal'));
        modal.show();
    }
    
    function showGitStatusModal(data) {
        // Create and show Git status modal
        const modalHtml = `
            <div class="modal fade" id="gitStatusModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="mdi mdi-git text-info"></i>
                                Git Repository Status
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Repository Information</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <th>URL:</th>
                                            <td><small>${data.repository_url || 'Not configured'}</small></td>
                                        </tr>
                                        <tr>
                                            <th>Branch:</th>
                                            <td><code>${data.branch || 'main'}</code></td>
                                        </tr>
                                        <tr>
                                            <th>Path:</th>
                                            <td><code>${data.path || 'hedgehog/'}</code></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Status Information</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Status:</th>
                                            <td>
                                                <span class="badge bg-${data.status === 'connected' ? 'success' : 'warning'}">
                                                    ${data.status || 'Unknown'}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Last Sync:</th>
                                            <td><small>${data.last_sync || 'Never'}</small></td>
                                        </tr>
                                        <tr>
                                            <th>Current Commit:</th>
                                            <td><code>${data.current_commit || 'Unknown'}</code></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            ${data.error ? `<div class="alert alert-danger mt-3"><small>${data.error}</small></div>` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if present
        const existingModal = document.getElementById('gitStatusModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body and show
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('gitStatusModal'));
        modal.show();
    }
    
    console.log('✅ Event listeners attached successfully (MVP1 + MVP2)');
});

// GitOps Integration Functions for Backend Connection
function refreshGitOpsStatus() {
    const fabricId = {{ object.pk }};
    const statusDisplay = document.getElementById('gitops-state-display');
    
    // Show loading state
    statusDisplay.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Refreshing GitOps status...';
    
    // Fetch GitOps status from backend
    fetch(`${window.location.origin}/plugins/hedgehog/api/fabrics/${fabricId}/gitops/sync/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateGitOpsDisplay(data);
        } else {
            statusDisplay.innerHTML = '<span class="badge bg-danger">Error</span> <small class="text-muted">Failed to refresh status</small>';
        }
    })
    .catch(error => {
        console.error('GitOps status refresh error:', error);
        statusDisplay.innerHTML = '<span class="badge bg-danger">Error</span> <small class="text-muted">Failed to refresh status</small>';
    });
}

// Store fabric ID globally for UnifiedSync
window.currentFabricId = {{ object.pk }};

function triggerGitSync() {
    const fabricId = {{ object.pk }};
    
    // Debug logging
    console.log('🔧 triggerGitSync called for fabric:', fabricId);
    console.log('🔧 UnifiedSync available:', !!(window.UnifiedSync && window.UnifiedSync.sync));
    console.log('🔧 Button element:', event.target);
    console.log('🔧 Current page URL:', window.location.href);
    console.log('🔧 Current hostname:', window.location.hostname);
    console.log('🔧 Current port:', window.location.port);
    
    if (!confirm('This will sync the latest changes from the Git repository. Continue?')) {
        return;
    }
    
    // Use environment-based endpoint discovery
    console.log('🔧 Using environment-based endpoint discovery');
    showNotification('Syncing from Git repository...', 'info');
    
    const timestamp = Date.now();
    // Use current origin for reliable endpoint discovery
    const baseUrl = window.location.origin;
    const syncUrl = `${baseUrl}/plugins/hedgehog/api/fabrics/${fabricId}/gitops/sync/?_cb=${timestamp}`;
    
    console.log('🔧 Making request to:', syncUrl);
    
    // Single endpoint with proper error handling
    async function performSync() {
        
        try {
            const response = await fetch(syncUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                cache: 'no-store'
            });
            
            console.log('🔧 Response status:', response.status);
            console.log('🔧 Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const text = await response.text();
            console.log('🔧 Response text (first 200 chars):', text.substring(0, 200));
            
            // Check if it's HTML (indicates wrong endpoint or error page)
            if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                throw new Error('Server returned HTML instead of JSON - possible routing issue');
            }
            
            // Try to parse as JSON
            let data;
            try {
                data = JSON.parse(text);
                console.log('🔧 Parsed JSON:', data);
            } catch (parseError) {
                throw new Error(`JSON parse failed: ${parseError.message}`);
            }
            
            // Success!
            console.log('🔧 SUCCESS with Git sync!');
            return data;
            
        } catch (error) {
            console.error('🔧 Git sync failed:', error.message);
            throw error;
        }
    }
    
    // Execute the sync
    performSync()
    .then(data => {
        if (data.success) {
            showNotification('Git sync completed successfully!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification('Git sync failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('🔧 Git sync failed:', error);
        showNotification('Git sync failed: ' + error.message, 'error');
    });
}

function showResourceStates() {
    const fabricId = {{ object.pk }};
    
    // Fetch resource states
    fetch(`/plugins/hedgehog/api/fabrics/${fabricId}/gitops/status/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResourceStatesModal(data.resource_stats);
        } else {
            showNotification('Failed to load resource states', 'error');
        }
    })
    .catch(error => {
        console.error('Resource states error:', error);
        showNotification('Failed to load resource states', 'error');
    });
}

function showDriftDetails() {
    const fabricId = {{ object.pk }};
    
    // Fetch drift details
    fetch(`/plugins/hedgehog/api/fabrics/${fabricId}/gitops/status/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showDriftDetailsModal(data.drift_status);
        } else {
            showNotification('Failed to load drift details', 'error');
        }
    })
    .catch(error => {
        console.error('Drift details error:', error);
        showNotification('Failed to load drift details', 'error');
    });
}

function updateGitOpsDisplay(data) {
    const statusDisplay = document.getElementById('gitops-state-display');
    const driftStatus = data.drift_status.drift_status || 'unknown';
    const driftCount = data.drift_status.drift_count || 0;
    
    let badgeClass = 'secondary';
    let icon = 'help-circle';
    let message = 'Status unknown';
    
    if (driftStatus === 'in_sync') {
        badgeClass = 'success';
        icon = 'check-circle';
        message = 'Git and cluster are aligned';
    } else if (driftStatus === 'drift_detected') {
        badgeClass = 'warning';
        icon = 'alert-circle';
        message = `${driftCount} resource(s) with drift`;
    }
    
    statusDisplay.innerHTML = `
        <span class="badge bg-${badgeClass}">
            <i class="mdi mdi-${icon}"></i> ${driftStatus.toUpperCase().replace('_', ' ')}
        </span>
        <small class="text-muted ms-2">${message}</small>
    `;
}

function showResourceStatesModal(resourceStats) {
    const modalHtml = `
        <div class="modal fade" id="resourceStatesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="mdi mdi-view-list text-info"></i>
                            Resource States Overview
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-primary">${resourceStats.total}</h3>
                                        <small>Total Resources</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-success">${resourceStats.synced}</h3>
                                        <small>Synced</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h3 class="text-warning">${resourceStats.drifted}</h3>
                                        <small>Drifted</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-secondary">${resourceStats.draft}</h4>
                                        <small>Draft</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-info">${resourceStats.committed}</h4>
                                        <small>Committed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning">${resourceStats.pending}</h4>
                                        <small>Pending</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-danger">${resourceStats.orphaned}</h4>
                                        <small>Orphaned</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('resourceStatesModal'));
    modal.show();
}

function showDriftDetailsModal(driftStatus) {
    const modalHtml = `
        <div class="modal fade" id="driftDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="mdi mdi-compare-horizontal text-warning"></i>
                            Drift Analysis Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Overall Status</h6>
                                <p><strong>Drift Status:</strong> ${driftStatus.drift_status || 'unknown'}</p>
                                <p><strong>Drift Count:</strong> ${driftStatus.drift_count || 0}</p>
                                <p><strong>Total Resources:</strong> ${driftStatus.total_resources || 0}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Last Analysis</h6>
                                <p><strong>Last Calculated:</strong> ${driftStatus.last_calculated || 'Never'}</p>
                                <p><strong>Details:</strong> ${driftStatus.details || 'No details available'}</p>
                            </div>
                        </div>
                        ${driftStatus.resource_details ? `
                        <div class="mt-3">
                            <h6>Resource Details</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Resource</th>
                                            <th>Status</th>
                                            <th>Score</th>
                                            <th>Summary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(driftStatus.resource_details).map(([name, details]) => `
                                            <tr>
                                                <td><code>${name}</code></td>
                                                <td><span class="badge bg-warning">${details.status}</span></td>
                                                <td>${details.score.toFixed(2)}</td>
                                                <td>${details.summary}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="refreshGitOpsStatus()">Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('driftDetailsModal'));
    modal.show();
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Utility function for notifications
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="mdi mdi-${type === 'success' ? 'check-circle' : type === 'info' ? 'information' : 'alert-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// GitOps File Management Functions
function processAllFiles(fabricId) {
    if (!confirm('Are you sure you want to process all pending files for this fabric?')) {
        return;
    }
    
    console.log('🔄 Processing all files for fabric:', fabricId);
    
    fetch(`/plugins/hedgehog/api/gitops/process-all/${fabricId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Processing initiated for ${data.file_count} files`, 'success');
            updateFileManagementStats();
        } else {
            showNotification(data.error || 'Processing failed', 'error');
        }
    })
    .catch(error => {
        console.error('Process all files error:', error);
        showNotification('Failed to process files', 'error');
    });
}

function optimizeStorage(fabricId) {
    if (!confirm('Optimize storage for this fabric? This may take a few minutes.')) {
        return;
    }
    
    console.log('⚡ Optimizing storage for fabric:', fabricId);
    
    fetch(`/plugins/hedgehog/api/gitops/optimize-storage/${fabricId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Storage optimized. Saved ${formatStorage(data.space_saved)}`, 'success');
            updateFileManagementStats();
        } else {
            showNotification(data.error || 'Storage optimization failed', 'error');
        }
    })
    .catch(error => {
        console.error('Storage optimization error:', error);
        showNotification('Failed to optimize storage', 'error');
    });
}

function updateFileManagementStats() {
    const fabricId = {{ object.pk }};
    
    fetch(`/plugins/hedgehog/api/gitops/file-stats/${fabricId}/`)
    .then(response => response.json())
    .then(data => {
        // Update file counts
        document.getElementById('raw-files-count').textContent = data.raw_files || 0;
        document.getElementById('processing-files-count').textContent = data.processing_files || 0;
        document.getElementById('managed-files-count').textContent = data.managed_files || 0;
        document.getElementById('archived-files-count').textContent = data.archived_files || 0;
        
        // Update storage sizes
        document.getElementById('raw-storage-size').textContent = formatStorage(data.raw_storage || 0);
        document.getElementById('managed-storage-size').textContent = formatStorage(data.managed_storage || 0);
        document.getElementById('archive-storage-size').textContent = formatStorage(data.archive_storage || 0);
        
        // Update recent activity
        updateRecentActivity(data.recent_activity || []);
    })
    .catch(error => {
        console.error('Failed to load file management stats:', error);
    });
}

function updateRecentActivity(activities) {
    const logContainer = document.querySelector('.file-activity-log');
    const noActivity = document.getElementById('no-activity');
    
    if (activities.length === 0) {
        noActivity.style.display = 'block';
        return;
    }
    
    noActivity.style.display = 'none';
    
    // Clear existing activity
    const existingActivities = logContainer.querySelectorAll('.activity-item');
    existingActivities.forEach(item => item.remove());
    
    // Add new activities
    activities.forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item d-flex align-items-center mb-2';
        
        const iconClass = getActivityIcon(activity.type);
        const timestamp = new Date(activity.timestamp).toLocaleTimeString();
        
        activityItem.innerHTML = `
            <i class="mdi mdi-${iconClass} text-${getActivityColor(activity.type)} me-2"></i>
            <div class="flex-grow-1">
                <div class="fw-bold">${activity.message}</div>
                <small class="text-muted">${timestamp}</small>
            </div>
        `;
        
        logContainer.appendChild(activityItem);
    });
}

function getActivityIcon(type) {
    const iconMap = {
        'file_added': 'file-plus',
        'file_processed': 'file-check',
        'file_archived': 'archive',
        'file_error': 'file-alert',
        'processing_started': 'play',
        'processing_completed': 'check-circle'
    };
    return iconMap[type] || 'information';
}

function getActivityColor(type) {
    const colorMap = {
        'file_added': 'info',
        'file_processed': 'success',
        'file_archived': 'secondary',
        'file_error': 'danger',
        'processing_started': 'primary',
        'processing_completed': 'success'
    };
    return colorMap[type] || 'secondary';
}

function formatStorage(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Auto-refresh file management stats every 30 seconds
setInterval(updateFileManagementStats, 30000);

// Load initial file management stats
document.addEventListener('DOMContentLoaded', function() {
    // Only load if GitOps is configured
    if (document.querySelector('.gitops-file-management-section .card')) {
        updateFileManagementStats();
    }
});

// Enhanced Drift Detection Functions
function showDriftAnalysis(fabricId) {
    console.log('🔍 Showing drift analysis for fabric:', fabricId);
    
    // Show loading state
    showNotification('Loading drift analysis...', 'info');
    
    // Fetch detailed drift analysis
    fetch(`/plugins/hedgehog/api/fabrics/${fabricId}/drift-analysis/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showDriftAnalysisModal(data);
        } else {
            showNotification('Failed to load drift analysis: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Drift analysis error:', error);
        showNotification('Failed to load drift analysis: ' + error.message, 'error');
    });
}

function checkForDrift(fabricId) {
    console.log('🔄 Checking for drift for fabric:', fabricId);
    
    if (!confirm('This will perform a comprehensive drift check against the Git repository. Continue?')) {
        return;
    }
    
    // Show loading notification
    showNotification('Checking for configuration drift...', 'info');
    
    // Trigger drift check
    fetch(`/plugins/hedgehog/api/fabrics/${fabricId}/check-drift/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Drift check completed successfully!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification('Drift check failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Drift check error:', error);
        showNotification('Drift check failed: ' + error.message, 'error');
    });
}

function viewDriftHistory(fabricId) {
    console.log('📚 Viewing drift history for fabric:', fabricId);
    
    // Fetch drift history
    fetch(`/plugins/hedgehog/api/fabrics/${fabricId}/drift-history/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showDriftHistoryModal(data);
        } else {
            showNotification('Failed to load drift history', 'error');
        }
    })
    .catch(error => {
        console.error('Drift history error:', error);
        showNotification('Failed to load drift history', 'error');
    });
}

function configureDriftSettings(fabricId) {
    console.log('⚙️ Configuring drift settings for fabric:', fabricId);
    
    // Show drift configuration modal
    showDriftConfigurationModal(fabricId);
}

function showDriftAnalysisModal(data) {
    const modalHtml = `
        <div class="modal fade" id="driftAnalysisModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="mdi mdi-chart-line text-warning"></i>
                            Drift Analysis Report
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <h3>${data.drift_summary.count || 0}</h3>
                                        <small>Resources with Drift</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h3>${data.drift_summary.total_resources || 0}</h3>
                                        <small>Total Resources</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h3>${data.drift_summary.synchronized || 0}</h3>
                                        <small>Synchronized</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body">
                                        <h3>${data.drift_summary.severity || 'Low'}</h3>
                                        <small>Severity Level</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${data.drift_details && data.drift_details.length > 0 ? `
                        <div class="mt-4">
                            <h6>Detailed Drift Analysis</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Resource</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Drift Score</th>
                                            <th>Last Modified</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.drift_details.map(item => `
                                            <tr>
                                                <td><code>${item.name}</code></td>
                                                <td><span class="badge bg-primary">${item.type}</span></td>
                                                <td>
                                                    <span class="badge bg-${item.status === 'drift' ? 'warning' : 'success'}">
                                                        ${item.status}
                                                    </span>
                                                </td>
                                                <td>${item.drift_score ? item.drift_score.toFixed(2) : 'N/A'}</td>
                                                <td>${item.last_modified || 'Unknown'}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewResourceDrift('${item.name}')">
                                                        <i class="mdi mdi-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : '<p class="text-muted">No detailed drift information available</p>'}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-warning" onclick="exportDriftReport()">
                            <i class="mdi mdi-download"></i> Export Report
                        </button>
                        <button type="button" class="btn btn-primary" id="modal-git-sync-btn" data-fabric-id="{{ object.pk }}" aria-label="Sync from Git repository">
                            <i class="mdi mdi-sync"></i> Sync from Git
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('driftAnalysisModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('driftAnalysisModal'));
    modal.show();
}

function showDriftHistoryModal(data) {
    const modalHtml = `
        <div class="modal fade" id="driftHistoryModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="mdi mdi-history text-info"></i>
                            Drift Detection History
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${data.history && data.history.length > 0 ? `
                        <div class="timeline">
                            ${data.history.map(entry => `
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-${entry.status === 'drift' ? 'warning' : 'success'}"></div>
                                    <div class="timeline-content">
                                        <h6>${entry.timestamp}</h6>
                                        <p>${entry.summary}</p>
                                        <small class="text-muted">
                                            ${entry.resources_affected || 0} resources affected
                                        </small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ` : '<p class="text-muted text-center">No drift history available</p>'}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('driftHistoryModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('driftHistoryModal'));
    modal.show();
}

function showDriftConfigurationModal(fabricId) {
    const modalHtml = `
        <div class="modal fade" id="driftConfigModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="mdi mdi-cog text-primary"></i>
                            Drift Detection Settings
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="driftConfigForm">
                            <div class="mb-3">
                                <label class="form-label">Detection Frequency</label>
                                <select class="form-select" name="detection_frequency">
                                    <option value="manual">Manual Only</option>
                                    <option value="hourly">Every Hour</option>
                                    <option value="daily" selected>Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sensitivity Level</label>
                                <select class="form-select" name="sensitivity">
                                    <option value="low">Low - Major changes only</option>
                                    <option value="medium" selected>Medium - Standard detection</option>
                                    <option value="high">High - All changes</option>
                                </select>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="auto_sync" id="autoSync" checked>
                                <label class="form-check-label" for="autoSync">
                                    Enable automatic sync on drift detection
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="notifications" id="notifications" checked>
                                <label class="form-check-label" for="notifications">
                                    Send notifications when drift is detected
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveDriftSettings(${fabricId})">
                            <i class="mdi mdi-content-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('driftConfigModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('driftConfigModal'));
    modal.show();
}

function saveDriftSettings(fabricId) {
    const form = document.getElementById('driftConfigForm');
    const formData = new FormData(form);
    
    // Convert to JSON
    const settings = {};
    formData.forEach((value, key) => {
        settings[key] = value;
    });
    
    // Add checkboxes manually (they don't appear in FormData if unchecked)
    settings.auto_sync = document.getElementById('autoSync').checked;
    settings.notifications = document.getElementById('notifications').checked;
    
    fetch(`/plugins/hedgehog/api/fabrics/${fabricId}/drift-settings/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Drift detection settings saved successfully!', 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('driftConfigModal'));
            modal.hide();
        } else {
            showNotification('Failed to save settings: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Save settings error:', error);
        showNotification('Failed to save settings: ' + error.message, 'error');
    });
}

function viewResourceDrift(resourceName) {
    console.log('👁️ Viewing drift details for resource:', resourceName);
    // This would show detailed diff view for a specific resource
    showNotification(`Detailed drift view for ${resourceName} not yet implemented`, 'info');
}

function exportDriftReport() {
    console.log('💾 Exporting drift report');
    showNotification('Drift report export not yet implemented', 'info');
}

// Progressive Disclosure Functions
async function syncFromGit() {
    const fabricId = {{ object.pk }};
    const button = event.target.closest('a');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Syncing...';
        button.style.pointerEvents = 'none';
        
        const response = await fetch(`/api/plugins/hedgehog/gitops-fabrics/${fabricId}/gitops_sync/`, {
            method: 'POST',
            headers: {
                'Authorization': 'Token {{ request.user.auth_token.key }}',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            button.innerHTML = '<i class="mdi mdi-check"></i> Sync Completed';
            showNotification('Sync completed successfully!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            button.innerHTML = '<i class="mdi mdi-alert"></i> Sync Failed';
            console.error('Sync failed:', result.error || 'Unknown error');
            showNotification('Sync failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        button.innerHTML = '<i class="mdi mdi-alert"></i> Error';
        console.error('Network error:', error.message || 'Unknown error');
        showNotification('Network error: ' + (error.message || 'Unknown error'), 'error');
    }
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.pointerEvents = 'auto';
    }, 3000);
}

async function initGitOps() {
    const fabricId = {{ object.pk }};
    const button = event.target.closest('a');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Initializing...';
        button.style.pointerEvents = 'none';
        
        const response = await fetch(`/api/plugins/hedgehog/fabrics/${fabricId}/init-gitops/`, {
            method: 'POST',
            headers: {
                'Authorization': 'Token {{ request.user.auth_token.key }}',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ force: false })
        });
        
        const result = await response.json();
        
        if (result.success) {
            button.innerHTML = '<i class="mdi mdi-check"></i> Initialized';
            showNotification('GitOps initialization completed!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            button.innerHTML = '<i class="mdi mdi-alert"></i> Failed';
            console.error('Init failed:', result.error || 'Unknown error');
            showNotification('Init failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        button.innerHTML = '<i class="mdi mdi-alert"></i> Error';
        console.error('Network error:', error.message || 'Unknown error');
        showNotification('Network error: ' + (error.message || 'Unknown error'), 'error');
    }
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.pointerEvents = 'auto';
    }, 3000);
}
</script>

<!-- Enhanced Interactive Elements JavaScript -->
<script src="{% static 'netbox_hedgehog/js/fabric-detail-enhanced.js' %}"></script>
<script>
// Initialize enhanced interactive elements when document is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Enhanced Fabric Detail Interactions Loaded');
    
    // Override existing onclick handlers with enhanced versions
    const buttons = document.querySelectorAll('[onclick*="showDriftAnalysis"], [onclick*="syncFromGit"], [onclick*="configureDriftSettings"]');
    buttons.forEach(button => {
        button.removeAttribute('onclick');
    });
    
    // Add enhanced error handling
    window.addEventListener('error', function(event) {
        console.error('JavaScript Error:', event.error);
        if (window.FabricDetailEnhanced && window.FabricDetailEnhanced.Utils) {
            window.FabricDetailEnhanced.Utils.showNotification(
                'An unexpected error occurred. Please try again.',
                'error'
            );
        }
    });
    
    console.log('✅ All interactive elements enhanced successfully');
});
</script>
{% endblock %}