{% extends 'generic/object.html' %}
{% load helpers %}

{% block content %}
<div class="row mb-3">
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">Topology Plan</h5>
            <div class="card-body">
                <table class="table table-hover attr-table">
                    <tr>
                        <th scope="row">Name</th>
                        <td>{{ object.name }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Customer</th>
                        <td>{{ object.customer_name|placeholder }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Status</th>
                        <td>{% badge object.get_status_display %}</td>
                    </tr>
                    <tr>
                        <th scope="row">Device Generation</th>
                        <td>
                            {% if not object.last_generated_at %}
                                {# Never generated #}
                                <span class="badge badge-secondary">
                                    <i class="mdi mdi-help-circle"></i> Not Generated
                                </span>
                            {% elif object.needs_regeneration %}
                                {# Out of sync #}
                                <span class="badge badge-warning">
                                    <i class="mdi mdi-alert"></i> Out of Sync
                                </span>
                                <br><small class="text-muted">Plan has changed since generation</small>
                            {% else %}
                                {# In sync #}
                                <span class="badge badge-success">
                                    <i class="mdi mdi-check-circle"></i> In Sync
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Created By</th>
                        <td>{{ object.created_by|placeholder }}</td>
                    </tr>
                </table>
            </div>
        </div>
        {% if object.description %}
        <div class="card">
            <h5 class="card-header">Description</h5>
            <div class="card-body">
                {{ object.description|markdown }}
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">Actions</h5>
            <div class="card-body">
                {# Unified Generate/Update Button (DIET #127) #}
                {% if perms.netbox_hedgehog.change_topologyplan and perms.dcim.add_device and perms.dcim.delete_device and perms.dcim.add_interface and perms.dcim.add_cable and perms.dcim.delete_cable %}
                <form method="post" action="{% url 'plugins:netbox_hedgehog:topologyplan_generate_update' pk=object.pk %}" class="mb-2">
                    {% csrf_token %}
                    {% if not object.last_generated_at %}
                        {# Never generated - show "Generate" #}
                        <button type="submit" class="btn btn-warning">
                            <i class="mdi mdi-cube"></i> Generate Devices
                        </button>
                    {% elif object.needs_regeneration %}
                        {# Out of sync - show "Update" #}
                        <button type="submit" class="btn btn-warning">
                            <i class="mdi mdi-cube"></i> Update Devices
                        </button>
                    {% else %}
                        {# In sync - show "Regenerate" #}
                        <button type="submit" class="btn btn-outline-warning">
                            <i class="mdi mdi-cube"></i> Regenerate Devices
                        </button>
                    {% endif %}
                </form>
                {% else %}
                <button type="button" class="btn btn-warning mb-2" disabled title="Contact administrator for device management permissions">
                    <i class="mdi mdi-cube"></i>
                    {% if not object.last_generated_at %}
                        Generate Devices
                    {% elif object.needs_regeneration %}
                        Update Devices
                    {% else %}
                        Regenerate Devices
                    {% endif %}
                </button>
                {% endif %}
                <a href="{% url 'plugins:netbox_hedgehog:topologyplan_export' pk=object.pk %}" class="btn btn-success">
                    <i class="mdi mdi-download"></i> Export YAML
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                Server Classes
                <span class="badge badge-secondary">{{ server_classes|length }}</span>
            </h5>
            <div class="card-body table-responsive">
                {% if server_classes %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>GPUs/Server</th>
                                <th>Total GPUs</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sc in server_classes %}
                            <tr>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planserverclass_detail' pk=sc.pk %}">{{ sc.server_class_id }}</a></td>
                                <td>{{ sc.get_category_display }}</td>
                                <td>{{ sc.quantity }}</td>
                                <td>{{ sc.gpus_per_server }}</td>
                                <td>{% widthratio sc.quantity 1 sc.gpus_per_server %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No server classes defined yet.</p>
                {% endif %}
                <a href="{% url 'plugins:netbox_hedgehog:planserverclass_add' %}?plan={{ object.pk }}" class="btn btn-sm btn-success">
                    <i class="mdi mdi-plus-thick"></i> Add Server Class
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                Switch Classes
                <span class="badge badge-secondary">{{ switch_classes|length }}</span>
            </h5>
            <div class="card-body table-responsive">
                {% if switch_classes %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fabric</th>
                                <th>Role</th>
                                <th>Calculated</th>
                                <th>Override</th>
                                <th>Effective</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sw in switch_classes %}
                            <tr>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planswitchclass_detail' pk=sw.pk %}">{{ sw.switch_class_id }}</a></td>
                                <td>{{ sw.get_fabric_display }}</td>
                                <td>{{ sw.get_hedgehog_role_display }}</td>
                                <td>{{ sw.calculated_quantity|placeholder }}</td>
                                <td>{{ sw.override_quantity|placeholder }}</td>
                                <td><strong>{{ sw.effective_quantity|placeholder }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No switch classes defined yet.</p>
                {% endif %}
                <a href="{% url 'plugins:netbox_hedgehog:planswitchclass_add' %}?plan={{ object.pk }}" class="btn btn-sm btn-success">
                    <i class="mdi mdi-plus-thick"></i> Add Switch Class
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                Server Connections
                <span class="badge badge-secondary">{{ server_connections|length }}</span>
            </h5>
            <div class="card-body table-responsive">
                {% if server_connections %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Connection ID</th>
                                <th>Server Class</th>
                                <th>Type</th>
                                <th>Distribution</th>
                                <th>Target Switch</th>
                                <th>Ports</th>
                                <th>Speed</th>
                                <th>Rail</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conn in server_connections %}
                            <tr>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planserverconnection_detail' pk=conn.pk %}">{{ conn.connection_id }}</a></td>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planserverclass_detail' pk=conn.server_class.pk %}">{{ conn.server_class.server_class_id }}</a></td>
                                <td>{{ conn.get_hedgehog_conn_type_display }}</td>
                                <td>{{ conn.get_distribution_display }}</td>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planswitchclass_detail' pk=conn.target_switch_class.pk %}">{{ conn.target_switch_class.switch_class_id }}</a></td>
                                <td>{{ conn.ports_per_connection }}</td>
                                <td>{{ conn.speed }}G</td>
                                <td>{{ conn.rail|placeholder }}</td>
                                <td>
                                    <a href="{% url 'plugins:netbox_hedgehog:planserverconnection_edit' pk=conn.pk %}" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="mdi mdi-pencil"></i>
                                    </a>
                                    <a href="{% url 'plugins:netbox_hedgehog:planserverconnection_delete' pk=conn.pk %}" class="btn btn-sm btn-danger" title="Delete">
                                        <i class="mdi mdi-delete"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No server connections defined yet.</p>
                {% endif %}
                <a href="{% url 'plugins:netbox_hedgehog:planserverconnection_add' %}" class="btn btn-sm btn-success">
                    <i class="mdi mdi-plus-thick"></i> Add Server Connection
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
