{% extends 'generic/object.html' %}
{% load helpers %}
{% load humanize %}

{% block content %}
<div class="row mb-3">
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">Topology Plan</h5>
            <div class="card-body">
                <table class="table table-hover attr-table">
                    <tr>
                        <th scope="row">Name</th>
                        <td>{{ object.name }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Customer</th>
                        <td>{{ object.customer_name|placeholder }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Status</th>
                        <td>{% badge object.get_status_display %}</td>
                    </tr>
                    <tr>
                        <th scope="row">Device Generation</th>
                        <td>
                            {% if object.generation_state and object.generation_state.status == 'queued' or object.generation_state and object.generation_state.status == 'in_progress' %}
                                {# Job running - QUEUED or IN_PROGRESS #}
                                <span class="badge badge-info">
                                    <i class="mdi mdi-loading mdi-spin"></i>
                                    {% if object.generation_state.status == 'queued' %}Queued{% else %}In Progress{% endif %}
                                </span>
                                {% if object.generation_state.job %}
                                <br><small class="text-muted">
                                    <a href="{{ object.generation_state.job.get_absolute_url }}" target="_blank">
                                        View job progress
                                    </a>
                                </small>
                                {% endif %}
                            {% elif object.generation_state and object.generation_state.status == 'failed' %}
                                {# Job failed #}
                                <span class="badge badge-danger">
                                    <i class="mdi mdi-alert-circle"></i> Failed
                                </span>
                                <br><small class="text-muted">
                                    Last attempted {{ object.last_generated_at|naturaltime }}.
                                    {% if object.generation_state.job %}
                                    <a href="{{ object.generation_state.job.get_absolute_url }}" target="_blank">
                                        View error details
                                    </a>
                                    {% endif %}
                                </small>
                            {% elif not object.last_generated_at %}
                                {# Never generated #}
                                <span class="badge badge-secondary">
                                    <i class="mdi mdi-help-circle"></i> Not Generated
                                </span>
                                <br><small class="text-muted">No devices have been generated yet</small>
                            {% elif object.needs_regeneration %}
                                {# Out of sync #}
                                <span class="badge badge-warning">
                                    <i class="mdi mdi-alert"></i> Out of Sync
                                </span>
                                <br><small class="text-muted">
                                    Last generated {{ object.last_generated_at|naturaltime }}.
                                    <strong>Plan has changed since generation.</strong>
                                </small>
                                {% if object.generation_state %}
                                <br><small class="text-muted">
                                    {{ object.generation_state.device_count }} devices,
                                    {{ object.generation_state.interface_count }} interfaces,
                                    {{ object.generation_state.cable_count }} cables
                                </small>
                                {% endif %}
                            {% else %}
                                {# In sync #}
                                <span class="badge badge-success">
                                    <i class="mdi mdi-check-circle"></i> In Sync
                                </span>
                                <br><small class="text-muted">
                                    Generated {{ object.last_generated_at|naturaltime }}
                                </small>
                                {% if object.generation_state %}
                                <br><small class="text-muted">
                                    <a href="{% url 'dcim:device_list' %}?tag=hedgehog-generated&cf_hedgehog_plan_id={{ object.pk }}" target="_blank">
                                        {{ object.generation_state.device_count }} devices
                                    </a>,
                                    {{ object.generation_state.interface_count }} interfaces,
                                    {{ object.generation_state.cable_count }} cables
                                </small>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">Created By</th>
                        <td>{{ object.created_by|placeholder }}</td>
                    </tr>
                </table>
            </div>
        </div>
        {% if object.description %}
        <div class="card">
            <h5 class="card-header">Description</h5>
            <div class="card-body">
                {{ object.description|markdown }}
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col col-md-6">
        <div class="card">
            <h5 class="card-header">Actions</h5>
            <div class="card-body">
                {# Unified Generate/Update Button (DIET #127 + #132) #}
                {% if object.generation_state and object.generation_state.status == 'queued' or object.generation_state and object.generation_state.status == 'in_progress' %}
                    {# Job running - disable button and show job link #}
                    <button type="button" class="btn btn-warning mb-2" disabled>
                        <i class="mdi mdi-loading mdi-spin"></i> Generation In Progress
                    </button>
                    {% if object.generation_state.job %}
                    <br>
                    <a href="{{ object.generation_state.job.get_absolute_url }}" class="btn btn-sm btn-info" target="_blank">
                        <i class="mdi mdi-eye"></i> View Job Status
                    </a>
                    {% endif %}
                {% elif can_generate_devices %}
                <form method="post" action="{% url 'plugins:netbox_hedgehog:topologyplan_generate_update' pk=object.pk %}" class="mb-2" id="generate-form">
                    {% csrf_token %}
                    {% if not object.last_generated_at %}
                        {# Never generated - show "Generate" #}
                        <button type="button" class="btn btn-warning" id="generate-btn"
                                data-first-time="{{ is_first_time_generation|yesno:'true,false' }}"
                                data-destructive="{{ is_destructive_regeneration|yesno:'true,false' }}"
                                data-device-count="{{ expected_device_count }}"
                                data-interface-count="{{ expected_interface_count }}"
                                data-cable-count="{{ expected_cable_count }}">
                            <i class="mdi mdi-cube"></i> <span class="btn-text">Generate Devices</span>
                        </button>
                    {% elif object.needs_regeneration %}
                        {# Out of sync - show "Update" #}
                        <button type="button" class="btn btn-warning" id="generate-btn"
                                data-first-time="{{ is_first_time_generation|yesno:'true,false' }}"
                                data-destructive="{{ is_destructive_regeneration|yesno:'true,false' }}"
                                data-device-count="{{ expected_device_count }}"
                                data-interface-count="{{ expected_interface_count }}"
                                data-cable-count="{{ expected_cable_count }}"
                                {% if object.generation_state %}
                                data-existing-devices="{{ object.generation_state.device_count }}"
                                data-existing-interfaces="{{ object.generation_state.interface_count }}"
                                data-existing-cables="{{ object.generation_state.cable_count }}"
                                {% endif %}>
                            <i class="mdi mdi-cube"></i> <span class="btn-text">Update Devices</span>
                        </button>
                    {% else %}
                        {# In sync - show "Regenerate" #}
                        <button type="button" class="btn btn-outline-warning" id="generate-btn"
                                data-first-time="{{ is_first_time_generation|yesno:'true,false' }}"
                                data-destructive="{{ is_destructive_regeneration|yesno:'true,false' }}"
                                data-device-count="{{ expected_device_count }}"
                                data-interface-count="{{ expected_interface_count }}"
                                data-cable-count="{{ expected_cable_count }}"
                                {% if object.generation_state %}
                                data-existing-devices="{{ object.generation_state.device_count }}"
                                data-existing-interfaces="{{ object.generation_state.interface_count }}"
                                data-existing-cables="{{ object.generation_state.cable_count }}"
                                {% endif %}>
                            <i class="mdi mdi-cube"></i> <span class="btn-text">Regenerate Devices</span>
                        </button>
                    {% endif %}
                </form>
                {% else %}
                <button type="button" class="btn btn-warning mb-2" disabled title="Contact administrator for device management permissions">
                    <i class="mdi mdi-cube"></i>
                    {% if not object.last_generated_at %}
                        Generate Devices
                    {% elif object.needs_regeneration %}
                        Update Devices
                    {% else %}
                        Regenerate Devices
                    {% endif %}
                </button>
                {% endif %}
                <a href="{% url 'plugins:netbox_hedgehog:topologyplan_export' pk=object.pk %}" class="btn btn-success">
                    <i class="mdi mdi-download"></i> Export YAML
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                Server Classes
                <span class="badge badge-secondary">{{ server_classes|length }}</span>
            </h5>
            <div class="card-body table-responsive">
                {% if server_classes %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>GPUs/Server</th>
                                <th>Total GPUs</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sc in server_classes %}
                            <tr>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planserverclass_detail' pk=sc.pk %}">{{ sc.server_class_id }}</a></td>
                                <td>{{ sc.get_category_display }}</td>
                                <td>{{ sc.quantity }}</td>
                                <td>{{ sc.gpus_per_server }}</td>
                                <td>{% widthratio sc.quantity 1 sc.gpus_per_server %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No server classes defined yet.</p>
                {% endif %}
                {% if object.generation_state and object.generation_state.status == 'queued' or object.generation_state and object.generation_state.status == 'in_progress' %}
                    <button type="button" class="btn btn-sm btn-success" disabled title="Plan is locked during device generation">
                        <i class="mdi mdi-plus-thick"></i> Add Server Class
                    </button>
                {% else %}
                    <a href="{% url 'plugins:netbox_hedgehog:planserverclass_add' %}?plan={{ object.pk }}" class="btn btn-sm btn-success">
                        <i class="mdi mdi-plus-thick"></i> Add Server Class
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                Switch Classes
                <span class="badge badge-secondary">{{ switch_classes|length }}</span>
            </h5>
            <div class="card-body table-responsive">
                {% if switch_classes %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fabric</th>
                                <th>Role</th>
                                <th>Calculated</th>
                                <th>Override</th>
                                <th>Effective</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sw in switch_classes %}
                            <tr>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planswitchclass_detail' pk=sw.pk %}">{{ sw.switch_class_id }}</a></td>
                                <td>{{ sw.get_fabric_display }}</td>
                                <td>{{ sw.get_hedgehog_role_display }}</td>
                                <td>{{ sw.calculated_quantity|placeholder }}</td>
                                <td>{{ sw.override_quantity|placeholder }}</td>
                                <td><strong>{{ sw.effective_quantity|placeholder }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No switch classes defined yet.</p>
                {% endif %}
                {% if object.generation_state and object.generation_state.status == 'queued' or object.generation_state and object.generation_state.status == 'in_progress' %}
                    <button type="button" class="btn btn-sm btn-success" disabled title="Plan is locked during device generation">
                        <i class="mdi mdi-plus-thick"></i> Add Switch Class
                    </button>
                {% else %}
                    <a href="{% url 'plugins:netbox_hedgehog:planswitchclass_add' %}?plan={{ object.pk }}" class="btn btn-sm btn-success">
                        <i class="mdi mdi-plus-thick"></i> Add Switch Class
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                Server Connections
                <span class="badge badge-secondary">{{ server_connections|length }}</span>
            </h5>
            <div class="card-body table-responsive">
                {% if server_connections %}
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Connection ID</th>
                                <th>Server Class</th>
                                <th>Type</th>
                                <th>Distribution</th>
                                <th>Target Switch</th>
                                <th>Ports</th>
                                <th>Speed</th>
                                <th>Rail</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conn in server_connections %}
                            <tr>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planserverconnection_detail' pk=conn.pk %}">{{ conn.connection_id }}</a></td>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planserverclass_detail' pk=conn.server_class.pk %}">{{ conn.server_class.server_class_id }}</a></td>
                                <td>{{ conn.get_hedgehog_conn_type_display }}</td>
                                <td>{{ conn.get_distribution_display }}</td>
                                <td><a href="{% url 'plugins:netbox_hedgehog:planswitchclass_detail' pk=conn.target_switch_class.pk %}">{{ conn.target_switch_class.switch_class_id }}</a></td>
                                <td>{{ conn.ports_per_connection }}</td>
                                <td>{{ conn.speed }}G</td>
                                <td>{{ conn.rail|placeholder }}</td>
                                <td>
                                    <a href="{% url 'plugins:netbox_hedgehog:planserverconnection_edit' pk=conn.pk %}" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="mdi mdi-pencil"></i>
                                    </a>
                                    <a href="{% url 'plugins:netbox_hedgehog:planserverconnection_delete' pk=conn.pk %}" class="btn btn-sm btn-danger" title="Delete">
                                        <i class="mdi mdi-delete"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No server connections defined yet.</p>
                {% endif %}
                {% if object.generation_state and object.generation_state.status == 'queued' or object.generation_state and object.generation_state.status == 'in_progress' %}
                    <button type="button" class="btn btn-sm btn-success" disabled title="Plan is locked during device generation">
                        <i class="mdi mdi-plus-thick"></i> Add Server Connection
                    </button>
                {% else %}
                    <a href="{% url 'plugins:netbox_hedgehog:planserverconnection_add' %}" class="btn btn-sm btn-success">
                        <i class="mdi mdi-plus-thick"></i> Add Server Connection
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Destructive Confirmation Modal #}
<div class="modal fade" id="destructiveConfirmModal" tabindex="-1" role="dialog" aria-labelledby="destructiveConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="destructiveConfirmModalLabel">
          <i class="mdi mdi-alert"></i> Confirm Destructive Regeneration
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Warning:</strong> This will delete and recreate all devices, interfaces, and cables for this plan.</p>
        <p>This is a destructive operation that cannot be undone.</p>
        <p>Are you sure you want to continue?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmDestructiveBtn">Yes, Regenerate</button>
      </div>
    </div>
  </div>
</div>

{# Expectation Guidance Modal #}
<div class="modal fade" id="expectationGuidanceModal" tabindex="-1" role="dialog" aria-labelledby="expectationGuidanceModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="expectationGuidanceModalLabel">
          <i class="mdi mdi-information"></i> Device Generation Started
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Device generation has been queued as a background job.</p>
        <p><strong>Expected results:</strong></p>
        <ul>
          <li id="expected-devices-msg">Devices: <span id="expected-devices">0</span></li>
          <li id="expected-interfaces-msg">Interfaces: <span id="expected-interfaces">0</span></li>
          <li id="expected-cables-msg">Cables: <span id="expected-cables">0</span></li>
        </ul>
        <p>You will be redirected to the job status page to monitor progress.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="viewJobBtn">View Job Status</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateForm = document.getElementById('generate-form');
    const generateBtn = document.getElementById('generate-btn');

    if (!generateForm || !generateBtn) {
        return; // Elements not present on this page
    }

    // Extract data attributes from button
    const isFirstTime = generateBtn.getAttribute('data-first-time') === 'true';
    const isDestructive = generateBtn.getAttribute('data-destructive') === 'true';
    const deviceCount = generateBtn.getAttribute('data-device-count');
    const interfaceCount = generateBtn.getAttribute('data-interface-count');
    const cableCount = generateBtn.getAttribute('data-cable-count');

    // Handle generate button click
    generateBtn.addEventListener('click', function(e) {
        e.preventDefault();

        if (isDestructive) {
            // Show destructive confirmation modal first
            $('#destructiveConfirmModal').modal('show');
        } else {
            // First-time generation: submit directly
            submitFormWithGuidance();
        }
    });

    // Handle destructive confirmation
    const confirmDestructiveBtn = document.getElementById('confirmDestructiveBtn');
    if (confirmDestructiveBtn) {
        confirmDestructiveBtn.addEventListener('click', function() {
            $('#destructiveConfirmModal').modal('hide');
            submitFormWithGuidance();
        });
    }

    // Submit form and show expectation guidance modal
    function submitFormWithGuidance() {
        // Populate expectation guidance modal with counts
        document.getElementById('expected-devices').textContent = deviceCount || '0';
        document.getElementById('expected-interfaces').textContent = interfaceCount || '0';
        document.getElementById('expected-cables').textContent = cableCount || '0';

        // Show expectation guidance modal
        $('#expectationGuidanceModal').modal('show');

        // Submit form (will redirect to job page)
        generateForm.submit();
    }

    // Handle "View Job Status" button (just closes modal, redirect happens automatically)
    const viewJobBtn = document.getElementById('viewJobBtn');
    if (viewJobBtn) {
        viewJobBtn.addEventListener('click', function() {
            $('#expectationGuidanceModal').modal('hide');
        });
    }
});
</script>
{% endblock %}
