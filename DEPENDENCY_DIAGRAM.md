# Dependency Diagram - HNP Architecture Analysis
**Date:** July 22, 2025  
**Agent:** Senior Backend Architect  
**Purpose:** Visual representation of current dependency issues and target architecture

## Current Architecture - Problematic Dependencies

### Module Dependency Map
```
netbox_hedgehog/
â”‚
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py          [AGGREGATOR] â”€â”€â”
â”‚   â”œâ”€â”€ base.py              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”œâ”€â”€ fabric.py            â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚   â”œâ”€â”€ git_repository.py    â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”˜   â”‚â”‚  
â”‚   â”œâ”€â”€ vpc_api.py           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚   â”œâ”€â”€ wiring_api.py        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   â”œâ”€â”€ gitops.py
â”‚   â””â”€â”€ reconciliation.py
â”‚
â”œâ”€â”€ utils/                   ğŸš¨ ARCHITECTURAL VIOLATIONS
â”‚   â”œâ”€â”€ git_directory_sync.py    â”€â”€â–º models/    [VIOLATION]
â”‚   â”œâ”€â”€ gitops_integration.py    â”€â”€â–º models/    [VIOLATION] 
â”‚   â”œâ”€â”€ kubernetes.py            â”€â”€â–º models/    [VIOLATION]
â”‚   â”œâ”€â”€ batch_reconciliation.py  â”€â”€â–º models/    [VIOLATION]
â”‚   â””â”€â”€ ...other utils
â”‚
â”œâ”€â”€ views/                   ğŸš¨ BYPASSING SERVICES
â”‚   â”œâ”€â”€ fabric_views.py          â”€â”€â–º utils/     [VIOLATION]
â”‚   â”œâ”€â”€ sync_views.py            â”€â”€â–º utils/     [VIOLATION]
â”‚   â”œâ”€â”€ vpc_views.py             â”€â”€â–º utils/     [VIOLATION]
â”‚   â””â”€â”€ wiring_views.py          â”€â”€â–º utils/     [VIOLATION]
â”‚
â””â”€â”€ services/                âš ï¸ UNDERUTILIZED
    â””â”€â”€ state_service.py     [GOOD EXAMPLE]
```

### Circular Dependency Detail
```
ğŸ”„ CIRCULAR DEPENDENCY CHAIN:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           fabric.py                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Line 306:                       â”‚   â”‚
â”‚   â”‚ def some_method(self):          â”‚   â”‚
â”‚   â”‚     # Late import to avoid      â”‚   â”‚
â”‚   â”‚     # circular dependency       â”‚   â”‚
â”‚   â”‚     from .git_repository import â”‚   â”‚
â”‚   â”‚         GitRepository           â”‚   â”‚
â”‚   â”‚     # Use GitRepository         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        git_repository.py                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Line 306:                       â”‚   â”‚
â”‚   â”‚ def some_method(self):          â”‚   â”‚
â”‚   â”‚     # Late import to avoid      â”‚   â”‚
â”‚   â”‚     # circular dependency       â”‚   â”‚
â”‚   â”‚     from .fabric import         â”‚   â”‚
â”‚   â”‚         HedgehogFabric          â”‚   â”‚
â”‚   â”‚     # Use HedgehogFabric        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            CIRCULAR DEPENDENCY!
```

### Utils-to-Models Violations
```
ğŸš¨ CRITICAL ARCHITECTURAL VIOLATIONS:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     UTILS       â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚     MODELS      â”‚
â”‚  (Should be     â”‚       â”‚   (Domain)      â”‚
â”‚ Infrastructure) â”‚       â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                          â”‚
         â”‚                          â”‚
         â”‚                          â–¼
    WRONG DIRECTION!          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚    SERVICES     â”‚
                             â”‚  (Minimal Use)  â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Specific Violations:
â€¢ git_directory_sync.py    â†’ models/fabric.py
â€¢ gitops_integration.py    â†’ models/vpc_api.py
â€¢ kubernetes.py            â†’ models/fabric.py
â€¢ batch_reconciliation.py  â†’ models/base.py
â€¢ audit_trail.py           â†’ models/gitops.py
```

## Target Architecture - Clean Dependencies

### Layered Architecture Design
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRESENTATION LAYER                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Templates   â”‚  â”‚    Forms    â”‚  â”‚   Static Files      â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  (CSS, JS, Images)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APPLICATION LAYER                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Views    â”‚  â”‚ API Views   â”‚  â”‚      Webhooks       â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BUSINESS LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Fabric    â”‚  â”‚  Git Sync   â”‚  â”‚     CRD Lifecycle   â”‚  â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚      Service        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   State     â”‚  â”‚ Kubernetes  â”‚  â”‚    Reconciliation   â”‚  â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚      Service        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DOMAIN LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Models    â”‚  â”‚ Validators  â”‚  â”‚   Business Rules    â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Choices   â”‚  â”‚   Signals   â”‚  â”‚    Domain Events    â”‚  â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 INFRASTRUCTURE LAYER                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Utils    â”‚  â”‚  External   â”‚  â”‚     Kubernetes      â”‚  â”‚
â”‚  â”‚  Helpers    â”‚  â”‚   APIs      â”‚  â”‚      Client         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Git      â”‚  â”‚  Database   â”‚  â”‚       Logging       â”‚  â”‚
â”‚  â”‚  Client     â”‚  â”‚ Operations  â”‚  â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Clean Dependency Flow
```
CORRECT DEPENDENCY DIRECTION:

Views â”€â”€â”€â”€â”€â”€â–º Services â”€â”€â”€â”€â”€â”€â–º Models â”€â”€â”€â”€â”€â”€â–º Utils
  â”‚              â”‚               â”‚              â”‚
  â”‚              â”‚               â”‚              â–¼
  â”‚              â”‚               â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              â”‚               â”‚         â”‚External  â”‚
  â”‚              â”‚               â”‚         â”‚Services  â”‚
  â”‚              â”‚               â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚              â”‚               â”‚
  â”‚              â”‚               â–¼
  â”‚              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚              â”‚         â”‚Domain    â”‚
  â”‚              â”‚         â”‚Logic     â”‚
  â”‚              â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚              â”‚
  â”‚              â–¼
  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         â”‚Business  â”‚
  â”‚         â”‚Logic     â”‚
  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚User      â”‚
â”‚Interface â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NO REVERSE DEPENDENCIES!
NO CIRCULAR DEPENDENCIES!
```

## Module Reorganization Plan

### Current Structure Issues
```
âŒ CURRENT PROBLEMATIC STRUCTURE:
netbox_hedgehog/
â”œâ”€â”€ models/          # Domain layer (correct)
â”œâ”€â”€ views/           # Presentation layer (correct)  
â”œâ”€â”€ utils/           # Infrastructure BUT imports models (wrong!)
â”œâ”€â”€ services/        # Business layer (underused)
â”œâ”€â”€ api/             # API layer (correct)
â””â”€â”€ forms/           # Presentation layer (correct)
```

### Target Clean Structure
```
âœ… TARGET CLEAN STRUCTURE:
netbox_hedgehog/
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ forms/
â”‚   â””â”€â”€ static/
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ webhooks/
â”œâ”€â”€ business/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ orchestrators/
â”‚   â””â”€â”€ workflows/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ validators/
â”‚   â”œâ”€â”€ choices/
â”‚   â””â”€â”€ events/
â””â”€â”€ infrastructure/
    â”œâ”€â”€ utils/
    â”œâ”€â”€ clients/
    â”œâ”€â”€ adapters/
    â””â”€â”€ repositories/
```

## Implementation Roadmap

### Phase 1: Break Circular Dependencies
```
PRIORITY 1 - URGENT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fabric.py â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º git_repository.py â”‚
â”‚                                      â”‚
â”‚ SOLUTION:                            â”‚
â”‚ 1. Use string foreign key references â”‚
â”‚ 2. Move shared logic to services     â”‚
â”‚ 3. Use dependency injection patterns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Establish Services Layer
```
CREATE SERVICES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FabricService  â”‚ â”‚ GitSyncService  â”‚ â”‚CRDLifecycleServ â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚ â€¢ Create fabric â”‚ â”‚ â€¢ Clone repos   â”‚ â”‚ â€¢ Create CRDs   â”‚
â”‚ â€¢ Update config â”‚ â”‚ â€¢ Parse YAML    â”‚ â”‚ â€¢ Update specs  â”‚
â”‚ â€¢ Manage state  â”‚ â”‚ â€¢ Sync to DB    â”‚ â”‚ â€¢ Delete CRDs   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚KubernetesServiceâ”‚ â”‚   StateService  â”‚ â”‚ReconService     â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚ â€¢ K8s API calls â”‚ â”‚ â€¢ State trans.  â”‚ â€¢ Drift detect   â”‚
â”‚ â€¢ Resource mgmt â”‚ â”‚ â€¢ Audit trail   â”‚ â€¢ Conflict resol â”‚
â”‚ â€¢ Health checks â”‚ â”‚ â€¢ Event logging â”‚ â€¢ Batch updates  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Refactor Utils
```
MOVE BUSINESS LOGIC FROM UTILS TO SERVICES:

âŒ utils/git_directory_sync.py    â”€â”€â–º âœ… services/git_sync_service.py
âŒ utils/gitops_integration.py    â”€â”€â–º âœ… services/gitops_service.py  
âŒ utils/batch_reconciliation.py  â”€â”€â–º âœ… services/reconciliation_service.py

KEEP ONLY PURE HELPERS IN UTILS:
âœ… utils/kubernetes_client.py     [Pure K8s API wrapper]
âœ… utils/yaml_parser.py           [Pure YAML operations]
âœ… utils/git_client.py            [Pure Git operations]
```

## Validation Strategy

### Architecture Tests
```python
def test_no_circular_dependencies():
    """Ensure no circular imports exist"""
    # Test each module can be imported independently
    
def test_dependency_direction():
    """Ensure correct dependency flow"""
    # Views should not import utils directly
    # Utils should not import models
    # Services should be primary business layer

def test_layer_separation():
    """Ensure clean layer boundaries"""
    # No cross-layer violations
    # Proper abstraction levels maintained
```

### Monitoring
```bash
# Regular dependency checks
python3 -c "import netbox_hedgehog.models"
python3 -c "import netbox_hedgehog.services"  
python3 -c "import netbox_hedgehog.utils"

# Architecture compliance monitoring
python3 manage.py test netbox_hedgehog.tests.architecture
```

## Success Metrics

### Short Term (This Week)
- [ ] Zero circular dependencies
- [ ] System stable 48+ hours
- [ ] Services layer established
- [ ] Critical utils refactored

### Long Term (End of Engagement)
- [ ] Clean architecture fully implemented
- [ ] All dependencies flow correctly
- [ ] Independent component testing possible
- [ ] Architecture validation automated

---

**Next Action:** Begin implementing Phase 1 - breaking the circular dependency between `fabric.py` and `git_repository.py` using string-based foreign key references.